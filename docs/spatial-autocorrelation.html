<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>2 Spatial autocorrelation | GEOG0114: Principles of Spatial Analysis</title>
  <meta name="description" content="2 Spatial autocorrelation | GEOG0114: Principles of Spatial Analysis handbook." />
  <meta name="generator" content="bookdown 0.24 and GitBook 2.6.7" />

  <meta property="og:title" content="2 Spatial autocorrelation | GEOG0114: Principles of Spatial Analysis" />
  <meta property="og:type" content="book" />
  <meta property="og:url" content="https://jtvandijk.github.io/GEOG0114_20212022/" />
  
  <meta property="og:description" content="2 Spatial autocorrelation | GEOG0114: Principles of Spatial Analysis handbook." />
  <meta name="github-repo" content="jtvandijk/GEOG0114_20212022" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="2 Spatial autocorrelation | GEOG0114: Principles of Spatial Analysis" />
  
  <meta name="twitter:description" content="2 Spatial autocorrelation | GEOG0114: Principles of Spatial Analysis handbook." />
  

<meta name="author" content="Justin van Dijk" />


<meta name="date" content="2022-07-13" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="spatial-operations.html"/>
<link rel="next" href="point-pattern-analysis.html"/>
<script src="libs/header-attrs-2.10/header-attrs.js"></script>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.0.1/anchor-sections.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.0.1/anchor-sections.js"></script>
<link href="libs/vembedr-0.1.4/css/vembedr.css" rel="stylesheet" />
<script src="libs/htmlwidgets-1.5.4/htmlwidgets.js"></script>
<link href="libs/leaflet-1.3.1/leaflet.css" rel="stylesheet" />
<script src="libs/leaflet-1.3.1/leaflet.js"></script>
<link href="libs/leafletfix-1.0.0/leafletfix.css" rel="stylesheet" />
<script src="libs/proj4-2.6.2/proj4.min.js"></script>
<script src="libs/Proj4Leaflet-1.0.1/proj4leaflet.js"></script>
<link href="libs/rstudio_leaflet-1.3.1/rstudio_leaflet.css" rel="stylesheet" />
<script src="libs/leaflet-binding-2.0.4.1/leaflet.js"></script>
<script src="libs/leaflet-providers-1.9.0/leaflet-providers_1.9.0.js"></script>
<script src="libs/leaflet-providers-plugin-2.0.4.1/leaflet-providers-plugin.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<link rel="stylesheet" href="assets/custom.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="toc-logo">
<a href="https://www.ucl.ac.uk/module-catalogue/modules/principles-of-spatial-analysis-GEOG0114"><img src="images/general/ucl_logo.png">
</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>About</a>
<ul>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#moodle"><i class="fa fa-check"></i>Moodle</a></li>
</ul></li>
<li class="chapter" data-level="1" data-path="spatial-operations.html"><a href="spatial-operations.html"><i class="fa fa-check"></i><b>1</b> Spatial operations</a>
<ul>
<li class="chapter" data-level="1.1" data-path="spatial-operations.html"><a href="spatial-operations.html#this_week_w03"><i class="fa fa-check"></i><b>1.1</b> This week</a></li>
<li class="chapter" data-level="1.2" data-path="spatial-operations.html"><a href="spatial-operations.html#lecture_w03"><i class="fa fa-check"></i><b>1.2</b> Lecture recording</a></li>
<li class="chapter" data-level="1.3" data-path="spatial-operations.html"><a href="spatial-operations.html#reading_w03"><i class="fa fa-check"></i><b>1.3</b> Reading list</a></li>
<li class="chapter" data-level="1.4" data-path="spatial-operations.html"><a href="spatial-operations.html#case_study_w03"><i class="fa fa-check"></i><b>1.4</b> Case study</a></li>
<li class="chapter" data-level="1.5" data-path="spatial-operations.html"><a href="spatial-operations.html#getting_started_w03"><i class="fa fa-check"></i><b>1.5</b> Getting started</a></li>
<li class="chapter" data-level="1.6" data-path="spatial-operations.html"><a href="spatial-operations.html#working-directory-and-libraries"><i class="fa fa-check"></i><b>1.6</b> Working directory and libraries</a></li>
<li class="chapter" data-level="1.7" data-path="spatial-operations.html"><a href="spatial-operations.html#loading_data_w03"><i class="fa fa-check"></i><b>1.7</b> Loading our data sets</a></li>
<li class="chapter" data-level="1.8" data-path="spatial-operations.html"><a href="spatial-operations.html#data-processing"><i class="fa fa-check"></i><b>1.8</b> Data Processing</a>
<ul>
<li class="chapter" data-level="1.8.1" data-path="spatial-operations.html"><a href="spatial-operations.html#reprojecting"><i class="fa fa-check"></i><b>1.8.1</b> Reprojecting</a></li>
<li class="chapter" data-level="1.8.2" data-path="spatial-operations.html"><a href="spatial-operations.html#dissolving"><i class="fa fa-check"></i><b>1.8.2</b> Dissolving</a></li>
<li class="chapter" data-level="1.8.3" data-path="spatial-operations.html"><a href="spatial-operations.html#subsetting"><i class="fa fa-check"></i><b>1.8.3</b> Subsetting</a></li>
<li class="chapter" data-level="1.8.4" data-path="spatial-operations.html"><a href="spatial-operations.html#unioning"><i class="fa fa-check"></i><b>1.8.4</b> Unioning</a></li>
<li class="chapter" data-level="1.8.5" data-path="spatial-operations.html"><a href="spatial-operations.html#clipping"><i class="fa fa-check"></i><b>1.8.5</b> Clipping</a></li>
<li class="chapter" data-level="1.8.6" data-path="spatial-operations.html"><a href="spatial-operations.html#attribute-selection"><i class="fa fa-check"></i><b>1.8.6</b> Attribute selection</a></li>
<li class="chapter" data-level="1.8.7" data-path="spatial-operations.html"><a href="spatial-operations.html#buffering"><i class="fa fa-check"></i><b>1.8.7</b> Buffering</a></li>
</ul></li>
<li class="chapter" data-level="1.9" data-path="spatial-operations.html"><a href="spatial-operations.html#greenspace-in-london"><i class="fa fa-check"></i><b>1.9</b> Greenspace in London</a></li>
<li class="chapter" data-level="1.10" data-path="spatial-operations.html"><a href="spatial-operations.html#attributions_w03"><i class="fa fa-check"></i><b>1.10</b> Attributions</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="spatial-autocorrelation.html"><a href="spatial-autocorrelation.html"><i class="fa fa-check"></i><b>2</b> Spatial autocorrelation</a>
<ul>
<li class="chapter" data-level="2.1" data-path="spatial-autocorrelation.html"><a href="spatial-autocorrelation.html#this_week_w04"><i class="fa fa-check"></i><b>2.1</b> This week</a></li>
<li class="chapter" data-level="2.2" data-path="spatial-autocorrelation.html"><a href="spatial-autocorrelation.html#lecture_w04"><i class="fa fa-check"></i><b>2.2</b> Lecture recording</a></li>
<li class="chapter" data-level="2.3" data-path="spatial-autocorrelation.html"><a href="spatial-autocorrelation.html#reading_w04"><i class="fa fa-check"></i><b>2.3</b> Reading list</a></li>
<li class="chapter" data-level="2.4" data-path="spatial-autocorrelation.html"><a href="spatial-autocorrelation.html#case_study_w04"><i class="fa fa-check"></i><b>2.4</b> Case study</a></li>
<li class="chapter" data-level="2.5" data-path="spatial-autocorrelation.html"><a href="spatial-autocorrelation.html#neighbours"><i class="fa fa-check"></i><b>2.5</b> Neighbours</a></li>
<li class="chapter" data-level="2.6" data-path="spatial-autocorrelation.html"><a href="spatial-autocorrelation.html#getting_started_w04"><i class="fa fa-check"></i><b>2.6</b> Getting started</a></li>
<li class="chapter" data-level="2.7" data-path="spatial-autocorrelation.html"><a href="spatial-autocorrelation.html#loading_data_w04"><i class="fa fa-check"></i><b>2.7</b> Loading our data sets</a></li>
<li class="chapter" data-level="2.8" data-path="spatial-autocorrelation.html"><a href="spatial-autocorrelation.html#euclidean-neighbours"><i class="fa fa-check"></i><b>2.8</b> Euclidean neighbours</a></li>
<li class="chapter" data-level="2.9" data-path="spatial-autocorrelation.html"><a href="spatial-autocorrelation.html#shared-boundary-neighbours"><i class="fa fa-check"></i><b>2.9</b> Shared boundary neighbours</a></li>
<li class="chapter" data-level="2.10" data-path="spatial-autocorrelation.html"><a href="spatial-autocorrelation.html#theft-in-camden"><i class="fa fa-check"></i><b>2.10</b> Theft in Camden</a></li>
<li class="chapter" data-level="2.11" data-path="spatial-autocorrelation.html"><a href="spatial-autocorrelation.html#global-morans-i"><i class="fa fa-check"></i><b>2.11</b> Global Moran’s I</a></li>
<li class="chapter" data-level="2.12" data-path="spatial-autocorrelation.html"><a href="spatial-autocorrelation.html#local-morans-i"><i class="fa fa-check"></i><b>2.12</b> Local Moran’s I</a></li>
<li class="chapter" data-level="2.13" data-path="spatial-autocorrelation.html"><a href="spatial-autocorrelation.html#tidy-data"><i class="fa fa-check"></i><b>2.13</b> Tidy data</a></li>
<li class="chapter" data-level="2.14" data-path="spatial-autocorrelation.html"><a href="spatial-autocorrelation.html#assignment_w04"><i class="fa fa-check"></i><b>2.14</b> Assignment</a></li>
<li class="chapter" data-level="2.15" data-path="spatial-autocorrelation.html"><a href="spatial-autocorrelation.html#attributions_w04"><i class="fa fa-check"></i><b>2.15</b> Attributions</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="point-pattern-analysis.html"><a href="point-pattern-analysis.html"><i class="fa fa-check"></i><b>3</b> Point pattern analysis</a>
<ul>
<li class="chapter" data-level="3.1" data-path="point-pattern-analysis.html"><a href="point-pattern-analysis.html#this_week_w07"><i class="fa fa-check"></i><b>3.1</b> This week</a></li>
<li class="chapter" data-level="3.2" data-path="point-pattern-analysis.html"><a href="point-pattern-analysis.html#lecture_w07"><i class="fa fa-check"></i><b>3.2</b> Lecture recording</a></li>
<li class="chapter" data-level="3.3" data-path="point-pattern-analysis.html"><a href="point-pattern-analysis.html#reading_w07"><i class="fa fa-check"></i><b>3.3</b> Reading list</a></li>
<li class="chapter" data-level="3.4" data-path="point-pattern-analysis.html"><a href="point-pattern-analysis.html#case_study_w07"><i class="fa fa-check"></i><b>3.4</b> Case study</a></li>
<li class="chapter" data-level="3.5" data-path="point-pattern-analysis.html"><a href="point-pattern-analysis.html#getting_started_w07"><i class="fa fa-check"></i><b>3.5</b> Getting started</a></li>
<li class="chapter" data-level="3.6" data-path="point-pattern-analysis.html"><a href="point-pattern-analysis.html#distance-based-methods"><i class="fa fa-check"></i><b>3.6</b> Distance-based methods</a></li>
<li class="chapter" data-level="3.7" data-path="point-pattern-analysis.html"><a href="point-pattern-analysis.html#density-based-methods"><i class="fa fa-check"></i><b>3.7</b> Density-based methods</a></li>
<li class="chapter" data-level="3.8" data-path="point-pattern-analysis.html"><a href="point-pattern-analysis.html#point-pattern-analysis-in-practice"><i class="fa fa-check"></i><b>3.8</b> Point pattern analysis in practice</a>
<ul>
<li class="chapter" data-level="3.8.1" data-path="point-pattern-analysis.html"><a href="point-pattern-analysis.html#example-uber"><i class="fa fa-check"></i><b>3.8.1</b> Example: Uber</a></li>
<li class="chapter" data-level="3.8.2" data-path="point-pattern-analysis.html"><a href="point-pattern-analysis.html#example-gbnames"><i class="fa fa-check"></i><b>3.8.2</b> Example: GBNames</a></li>
</ul></li>
<li class="chapter" data-level="3.9" data-path="point-pattern-analysis.html"><a href="point-pattern-analysis.html#assignment_w07"><i class="fa fa-check"></i><b>3.9</b> Assignment</a></li>
<li class="chapter" data-level="3.10" data-path="point-pattern-analysis.html"><a href="point-pattern-analysis.html#attributions_w07"><i class="fa fa-check"></i><b>3.10</b> Attributions</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="geodemographics.html"><a href="geodemographics.html"><i class="fa fa-check"></i><b>4</b> Geodemographics</a>
<ul>
<li class="chapter" data-level="4.1" data-path="geodemographics.html"><a href="geodemographics.html#this_week_w09"><i class="fa fa-check"></i><b>4.1</b> This week</a></li>
<li class="chapter" data-level="4.2" data-path="geodemographics.html"><a href="geodemographics.html#lecture_w09"><i class="fa fa-check"></i><b>4.2</b> Lecture recording</a></li>
<li class="chapter" data-level="4.3" data-path="geodemographics.html"><a href="geodemographics.html#reading_w09"><i class="fa fa-check"></i><b>4.3</b> Reading list</a></li>
<li class="chapter" data-level="4.4" data-path="geodemographics.html"><a href="geodemographics.html#case_study_w09"><i class="fa fa-check"></i><b>4.4</b> Case study</a></li>
<li class="chapter" data-level="4.5" data-path="geodemographics.html"><a href="geodemographics.html#internet-user-classification"><i class="fa fa-check"></i><b>4.5</b> Internet User Classification</a></li>
<li class="chapter" data-level="4.6" data-path="geodemographics.html"><a href="geodemographics.html#assignment_w09_1"><i class="fa fa-check"></i><b>4.6</b> Assignment 1</a></li>
<li class="chapter" data-level="4.7" data-path="geodemographics.html"><a href="geodemographics.html#k-means-clustering"><i class="fa fa-check"></i><b>4.7</b> K-means clustering</a></li>
<li class="chapter" data-level="4.8" data-path="geodemographics.html"><a href="geodemographics.html#assignment_w09_2"><i class="fa fa-check"></i><b>4.8</b> Assignment 2</a></li>
<li class="chapter" data-level="4.9" data-path="geodemographics.html"><a href="geodemographics.html#attributions_w09"><i class="fa fa-check"></i><b>4.9</b> Attributions</a></li>
</ul></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">GEOG0114: Principles of Spatial Analysis</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="spatial-autocorrelation" class="section level1" number="2">
<h1><span class="header-section-number">2</span> Spatial autocorrelation</h1>
<div id="this_week_w04" class="section level2" number="2.1">
<h2><span class="header-section-number">2.1</span> This week</h2>
<p>This week, we focus on the first of two key properties of spatial data: spatial dependence. Spatial dependence is the idea that the observed value of a variable in one location is often dependent (to some degree) on the observed value of the same value in a nearby location. For spatial analysis, this dependence can be assessed and measured statistically by considering the level of spatial autocorrelation between values of a specific variable, observed in either different locations or between pairs of variables observed at the same location. Spatial autocorrelation occurs when these values are not independent of one another and instead cluster together across geographic space.</p>
<p>A critical first step of spatial autocorrelation is to define the criteria under which a spatial unit (e.g. an areal or point unit) can be understood as a “neighbour” to another unit. As highlighted in previous weeks, spatial properties can often take on several meanings, and as a result, have an impact on the validity and accuracy of spatial analysis. This multiplicity also can be applied to the concept of spatial neighbours which can be defined through adjacency, contiguity or distance-based measures. As the specification of these criteria can impact the results, the definition followed therefore need to be grounded in particular theory that aims to represent the process and variable investigated.</p>
</div>
<div id="lecture_w04" class="section level2" number="2.2">
<h2><span class="header-section-number">2.2</span> Lecture recording</h2>
<div class="vembedr" align="left">
<div>
<iframe src="https://web.microsoftstream.com/embed/video/01dc4984-23a2-43bf-8bf0-386ba2bc3ce3?autoplay=false&amp;showinfo=true" width="533" height="300" style="border:none;"></iframe>
</div>
</div>
<p><a href="https://github.com/jtvandijk/GEOG0114/tree/master/data/slides/w04_psa.pdf">[Lecture slides]</a> <a href="https://web.microsoftstream.com/video/01dc4984-23a2-43bf-8bf0-386ba2bc3ce3">[Watch on MS stream]</a></p>
</div>
<div id="reading_w04" class="section level2" number="2.3">
<h2><span class="header-section-number">2.3</span> Reading list</h2>
<ul>
<li>Gimond, M. 2021. Intro to GIS and spatial analysis. <strong>Chapter 13</strong>: Spatial autocorrelation. <a href="https://mgimond.github.io/Spatial/spatial-autocorrelation.html">[Link]</a></li>
<li>Longley, P. <em>et al.</em> 2015. Geographic Information Science &amp; systems, <strong>Chapter 2</strong>: The Nature of Geographic Data. <a href="https://rl.talis.com/3/ucl/items/ea2386fb-19dc-460a-acba-bda3737546c2.html?lang=en-gb&amp;login=1">[Link]</a></li>
<li>Longley, P. <em>et al.</em> 2015. Geographic Information Science &amp; systems, <strong>Chapter 13</strong>: Spatial Analysis. <a href="https://rl.talis.com/3/ucl/items/fd38ec78-2bea-4165-aab3-0e9d9093db8e.html?lang=en-gb&amp;login=1">[Link]</a></li>
<li>Radil, S. 2016. Spatial analysis of crime. In: Huebner, B. and Bynum, T. <em>The Handbook of Measurement Issues in Criminology and Criminal Justice</em>, Chapter 24, pp.536-554. <a href="https://doi.org/10.1002/9781118868799.ch24">[Link]</a></li>
</ul>
</div>
<div id="case_study_w04" class="section level2" number="2.4">
<h2><span class="header-section-number">2.4</span> Case study</h2>
<p>This week looks at spatial dependence and autocorrelation in detail, focusing on the different methods of assessment. As part of this, we look at the multiple methods to defining spatial neighbours and their suitability of use across different spatial phenomena – and how this approach is used to generate spatial weights for use within these spatial autocorrelation methods as well as their potential to generate spatially-explicit variables.</p>
<p>We put these learnings into practice through an analysis of spatial dependence of areal crime data, experimenting with the deployment of different neighbours and the impact of their analyses. For this practical we will look at the distribution of thefts from persons in the borough of Camden.</p>
</div>
<div id="neighbours" class="section level2" number="2.5">
<h2><span class="header-section-number">2.5</span> Neighbours</h2>
<p>If we want to come up with quantifiable descriptions of variables and how they vary over space, then we need to find ways of quantifying the distance from point to point. When you attach values to the polygons of wards in London, and visualise them, different patterns appear, and the different shapes and sizes of the polygons effect what these patterns look like. There can appear to be clusters, or the distribution can be random. If you want to explain and discuss variables, the underlying causes, and the possible solutions to issues, it becomes useful to quantify how clustered, or at the opposite end, how random these distributions are. This issue is known as spatial autocorrelation.</p>
<p>In raster data, variables are measured at regular spatial intervals (or interpolated to be represented as such). Each measurement is regularly spaced from its neighbours, like the pixels on the screen you are reading this from. With vector data, the distance of measurement to measurement, and the size and shape of the “pixel” of measurement becomes part of the captured information. Whilst this can allow for more nuanced representations of spatial phenomena, it also means that the quantity and type of distance between measurements needs to be acknowledged.</p>
<p>If you want to calculate the relative spatial relation of distributions, knowledge of what counts as a “neighbour” becomes useful. Neighbours can be neighbours due to euclidean distance (distance in space), or they can be due to shared relationships, like a shared boundary, or they can simply be the nearest neighbour, if there aren’t many other vectors around. Depending on the variable you are measuring the appropriateness of neighbourhood calculation techniques can change.</p>
</div>
<div id="getting_started_w04" class="section level2" number="2.6">
<h2><span class="header-section-number">2.6</span> Getting started</h2>
<p>To begin let’s load the libraries needed for this practical. Install the libraries where necessary.</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb34-1"><a href="spatial-autocorrelation.html#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="co"># libraries</span></span>
<span id="cb34-2"><a href="spatial-autocorrelation.html#cb34-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sf)</span>
<span id="cb34-3"><a href="spatial-autocorrelation.html#cb34-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(nngeo)</span>
<span id="cb34-4"><a href="spatial-autocorrelation.html#cb34-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(data.table)</span>
<span id="cb34-5"><a href="spatial-autocorrelation.html#cb34-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tmap)</span>
<span id="cb34-6"><a href="spatial-autocorrelation.html#cb34-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span></code></pre></div>
<p>Download the data necessary for the practical and put it in a folder we can find. We will use the same structure as the data directory from the previous week. If you are using the same directory for this weeks work then you can put these files in the same directories. If not make new ones with names that work. Alternatively you can make your own structure and use that.</p>
<div class="note">
<p><strong>Note</strong><br/>
To follow along with the code as it is and not edit the file paths there should be a folder called <strong>data/</strong> in your project working directory, if not best to make one. Inside this create a folder called <strong>crime</strong>. Put the <em>2019_camden_theft_from_person.csv</em> file in that folder. Inside your <strong>data/</strong> directory there should already be a folder called <strong>administrative_boundaries</strong>. Save the files belonging to the <em>OAs_camden_2011.shp</em> in here.</p>
</div>
<div id="file-download-1" class="section level4 unnumbered">
<h4>File download</h4>
<table>
<thead>
<tr class="header">
<th align="left">File</th>
<th align="left">Type</th>
<th align="left">Link</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">Theft in Camden</td>
<td align="left"><code>shp</code>, <code>csv</code></td>
<td align="left"><a href="https://github.com/jtvandijk/GEOG0114/tree/master/data/zip/camden_theft.zip">Download</a></td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="loading_data_w04" class="section level2" number="2.7">
<h2><span class="header-section-number">2.7</span> Loading our data sets</h2>
<p>Now we have the data in the correct folders, we can load and plot the shape data.</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb35-1"><a href="spatial-autocorrelation.html#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="co"># load camden boundaries</span></span>
<span id="cb35-2"><a href="spatial-autocorrelation.html#cb35-2" aria-hidden="true" tabindex="-1"></a>camden_oas <span class="ot">&lt;-</span> <span class="fu">st_read</span>(<span class="st">&#39;data/administrative_boundaries/OAs_camden_2011.shp&#39;</span>, <span class="at">crs=</span><span class="dv">27700</span>)</span></code></pre></div>
<pre><code>## Reading layer `OAs_camden_2011&#39; from data source 
##   `/Users/justinvandijk/Dropbox/UCL/Web/jtvandijk.github.io/GEOG0114_21_22/data/administrative_boundaries/OAs_camden_2011.shp&#39; 
##   using driver `ESRI Shapefile&#39;
## Simple feature collection with 749 features and 17 fields
## Geometry type: MULTIPOLYGON
## Dimension:     XY
## Bounding box:  xmin: 523954.5 ymin: 180965.4 xmax: 531554.9 ymax: 187603.6
## Projected CRS: OSGB 1936 / British National Grid</code></pre>
<div class="sourceCode" id="cb37"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb37-1"><a href="spatial-autocorrelation.html#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="co"># inspect</span></span>
<span id="cb37-2"><a href="spatial-autocorrelation.html#cb37-2" aria-hidden="true" tabindex="-1"></a><span class="fu">tm_shape</span>(camden_oas) <span class="sc">+</span></span>
<span id="cb37-3"><a href="spatial-autocorrelation.html#cb37-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_polygons</span>()</span></code></pre></div>
<p><img src="GEOG0114_files/figure-html/load-those-shapes-for-camden-1.png" width="672" /></p>
<p>You can see how one of these output areas could have many more neighbours than others, they vary a great deal in size and shape. The dimensions of these objects change over space, as a result the measurements within them must change too.</p>
<p>Output areas are designed to convey and contain census information, so they are created in a way that maintains a similar number of residents in each one. The more sparsely populated an OA the larger it is. Output Areas are designed to cover the entirety of the land of England and Wales so they stretch over places where there are no people. In the north of Camden the largest Ouput Areas span over Hampstead Heath, a large park.</p>
<p>Let’s explore how to find different kinds of neighbours using the example of one ‘randomly’ selected output area (<strong>E00004174</strong>) that happens to contain the UCL main campus.</p>
<div class="sourceCode" id="cb38"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb38-1"><a href="spatial-autocorrelation.html#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="co"># highlight E00004174</span></span>
<span id="cb38-2"><a href="spatial-autocorrelation.html#cb38-2" aria-hidden="true" tabindex="-1"></a><span class="fu">tm_shape</span>(camden_oas) <span class="sc">+</span></span>
<span id="cb38-3"><a href="spatial-autocorrelation.html#cb38-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_borders</span>(<span class="at">col=</span><span class="st">&#39;black&#39;</span>) <span class="sc">+</span></span>
<span id="cb38-4"><a href="spatial-autocorrelation.html#cb38-4" aria-hidden="true" tabindex="-1"></a><span class="fu">tm_shape</span>(camden_oas[camden_oas<span class="sc">$</span>OA11CD<span class="sc">==</span><span class="st">&#39;E00004174&#39;</span>,]) <span class="sc">+</span></span>
<span id="cb38-5"><a href="spatial-autocorrelation.html#cb38-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_fill</span>(<span class="at">col=</span><span class="st">&#39;red&#39;</span>)</span></code></pre></div>
<p><img src="GEOG0114_files/figure-html/04-c-highlighting-one-oa-1.png" width="672" /></p>
</div>
<div id="euclidean-neighbours" class="section level2" number="2.8">
<h2><span class="header-section-number">2.8</span> Euclidean neighbours</h2>
<p>The first way we are going to call something a neighbour is by using Euclidean distance. As our OA shapefile is projected in BNG (British National Grid), the coordinates are planar, going up 1 is the same distance as going sideways 1. Even better the coordinates are in metric measurements so it’s easy to make up heuristic distances.</p>
<p>Let’s call every output area with a centroid 500m or less away from the centroid of our chosen OA a neighbour:</p>
<ul>
<li>we select only the the centroid of our chosen output area and all other areas (with <code>st_centroid()</code>)</li>
<li>we set the maximum number of neighbours we want to find to “50” (with parameter <code>k</code>)</li>
<li>we set the maximum distance of calling an OA centroid a neigbour to “500” (with parameter <code>maxdist</code>)</li>
<li>we return a sparse matrix that tells us whether each OA is a neighbour or not (with parameter <code>sparse</code>)</li>
</ul>
<div class="sourceCode" id="cb39"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb39-1"><a href="spatial-autocorrelation.html#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="co"># assign our chosen OA to a variable </span></span>
<span id="cb39-2"><a href="spatial-autocorrelation.html#cb39-2" aria-hidden="true" tabindex="-1"></a>chosen_oa <span class="ot">&lt;-</span> <span class="st">&#39;E00004174&#39;</span></span>
<span id="cb39-3"><a href="spatial-autocorrelation.html#cb39-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-4"><a href="spatial-autocorrelation.html#cb39-4" aria-hidden="true" tabindex="-1"></a><span class="co"># identify neighbours</span></span>
<span id="cb39-5"><a href="spatial-autocorrelation.html#cb39-5" aria-hidden="true" tabindex="-1"></a>chosen_oa_neighbours <span class="ot">&lt;-</span> <span class="fu">st_nn</span>(<span class="fu">st_geometry</span>(<span class="fu">st_centroid</span>(camden_oas[camden_oas<span class="sc">$</span>OA11CD<span class="sc">==</span>chosen_oa,])), </span>
<span id="cb39-6"><a href="spatial-autocorrelation.html#cb39-6" aria-hidden="true" tabindex="-1"></a>                              <span class="fu">st_geometry</span>(<span class="fu">st_centroid</span>(camden_oas)),</span>
<span id="cb39-7"><a href="spatial-autocorrelation.html#cb39-7" aria-hidden="true" tabindex="-1"></a>                              <span class="at">sparse =</span> <span class="cn">TRUE</span>,</span>
<span id="cb39-8"><a href="spatial-autocorrelation.html#cb39-8" aria-hidden="true" tabindex="-1"></a>                              <span class="at">k =</span> <span class="dv">50</span>,</span>
<span id="cb39-9"><a href="spatial-autocorrelation.html#cb39-9" aria-hidden="true" tabindex="-1"></a>                              <span class="at">maxdist =</span> <span class="dv">500</span>) </span></code></pre></div>
<pre><code>## projected points</code></pre>
<div class="sourceCode" id="cb41"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb41-1"><a href="spatial-autocorrelation.html#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="co"># inspect</span></span>
<span id="cb41-2"><a href="spatial-autocorrelation.html#cb41-2" aria-hidden="true" tabindex="-1"></a><span class="fu">class</span>(chosen_oa_neighbours)</span></code></pre></div>
<pre><code>## [1] &quot;list&quot;</code></pre>
<div class="sourceCode" id="cb43"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb43-1"><a href="spatial-autocorrelation.html#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="co"># get the names (codes) of these neighbours</span></span>
<span id="cb43-2"><a href="spatial-autocorrelation.html#cb43-2" aria-hidden="true" tabindex="-1"></a>neighbour_names <span class="ot">&lt;-</span> camden_oas[chosen_oa_neighbours[[<span class="dv">1</span>]],]</span>
<span id="cb43-3"><a href="spatial-autocorrelation.html#cb43-3" aria-hidden="true" tabindex="-1"></a>neighbour_names <span class="ot">&lt;-</span> neighbour_names<span class="sc">$</span>OA11CD</span>
<span id="cb43-4"><a href="spatial-autocorrelation.html#cb43-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-5"><a href="spatial-autocorrelation.html#cb43-5" aria-hidden="true" tabindex="-1"></a><span class="co"># inspect</span></span>
<span id="cb43-6"><a href="spatial-autocorrelation.html#cb43-6" aria-hidden="true" tabindex="-1"></a><span class="fu">tm_shape</span>(camden_oas) <span class="sc">+</span> </span>
<span id="cb43-7"><a href="spatial-autocorrelation.html#cb43-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_borders</span>() <span class="sc">+</span></span>
<span id="cb43-8"><a href="spatial-autocorrelation.html#cb43-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># highlight only the neighbours</span></span>
<span id="cb43-9"><a href="spatial-autocorrelation.html#cb43-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_shape</span>(camden_oas[camden_oas<span class="sc">$</span>OA11CD <span class="sc">%in%</span> neighbour_names,]) <span class="sc">+</span> </span>
<span id="cb43-10"><a href="spatial-autocorrelation.html#cb43-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_fill</span>(<span class="at">col =</span> <span class="st">&#39;green&#39;</span>) <span class="sc">+</span></span>
<span id="cb43-11"><a href="spatial-autocorrelation.html#cb43-11" aria-hidden="true" tabindex="-1"></a>  <span class="co"># highlight only the chosen OA</span></span>
<span id="cb43-12"><a href="spatial-autocorrelation.html#cb43-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_shape</span>(camden_oas[camden_oas<span class="sc">$</span>OA11CD<span class="sc">==</span>chosen_oa,]) <span class="sc">+</span> </span>
<span id="cb43-13"><a href="spatial-autocorrelation.html#cb43-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_fill</span>(<span class="at">col =</span> <span class="st">&#39;red&#39;</span>) <span class="sc">+</span></span>
<span id="cb43-14"><a href="spatial-autocorrelation.html#cb43-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_shape</span>(camden_oas) <span class="sc">+</span> </span>
<span id="cb43-15"><a href="spatial-autocorrelation.html#cb43-15" aria-hidden="true" tabindex="-1"></a>  <span class="co"># overlay the borders</span></span>
<span id="cb43-16"><a href="spatial-autocorrelation.html#cb43-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_borders</span>(<span class="at">col=</span><span class="st">&#39;black&#39;</span>)</span></code></pre></div>
<p><img src="GEOG0114_files/figure-html/04-d-euclidean-distance-neighbour-1.png" width="672" /></p>
</div>
<div id="shared-boundary-neighbours" class="section level2" number="2.9">
<h2><span class="header-section-number">2.9</span> Shared boundary neighbours</h2>
<p>The next way of calculating neighbours takes into account the actual shape and location of the polygons in our shapefile. This has only recently been added to the world of <code>sf()</code>, previously we would have reverted to using the <code>sp()</code> package and others that depend on it such as <code>spdep()</code>.</p>
<p>We can create two functions that check whether any polygons share boundaries or overlap one another, and then also check by how much. These new functions are based on the <code>st_relate()</code> function. The different cases of these are known as queen, and rook. These describe the relations in a similar way to the possible chess board movements of these pieces.</p>
<div class="note">
<p><strong>Note</strong><br/>
Do have a look at the short lectures by Luc Anselin on <a href="https://www.youtube.com/watch?v=qWQ1Pa5cbtw">Moran’s I</a>, the <a href="https://www.youtube.com/watch?v=_J_bmWmOF3I">interpretation of Moran’s I</a>, and <a href="https://www.youtube.com/watch?v=xMXFvRO4cEM">neighbours and spatial weights</a> for some additional explanation on measuring spatial autocorrelation with Moran’s I.</p>
</div>
<div class="sourceCode" id="cb44"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb44-1"><a href="spatial-autocorrelation.html#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="co"># for rook case</span></span>
<span id="cb44-2"><a href="spatial-autocorrelation.html#cb44-2" aria-hidden="true" tabindex="-1"></a>st_rook <span class="ot">=</span> <span class="cf">function</span>(a, <span class="at">b =</span> a) <span class="fu">st_relate</span>(a, b, <span class="at">pattern =</span> <span class="st">&#39;F***1****&#39;</span>)</span>
<span id="cb44-3"><a href="spatial-autocorrelation.html#cb44-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-4"><a href="spatial-autocorrelation.html#cb44-4" aria-hidden="true" tabindex="-1"></a><span class="co"># for queen case</span></span>
<span id="cb44-5"><a href="spatial-autocorrelation.html#cb44-5" aria-hidden="true" tabindex="-1"></a>st_queen <span class="ot">&lt;-</span> <span class="cf">function</span>(a, <span class="at">b =</span> a) <span class="fu">st_relate</span>(a, b, <span class="at">pattern =</span> <span class="st">&#39;F***T****&#39;</span>)</span></code></pre></div>
<p>Now that we’ve created the functions lets try them out.</p>
<div class="sourceCode" id="cb45"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb45-1"><a href="spatial-autocorrelation.html#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="co"># identify neighbours</span></span>
<span id="cb45-2"><a href="spatial-autocorrelation.html#cb45-2" aria-hidden="true" tabindex="-1"></a>chosen_oa_neighbours <span class="ot">&lt;-</span> <span class="fu">st_rook</span>(<span class="fu">st_geometry</span>(camden_oas[camden_oas<span class="sc">$</span>OA11CD<span class="sc">==</span>chosen_oa,]), </span>
<span id="cb45-3"><a href="spatial-autocorrelation.html#cb45-3" aria-hidden="true" tabindex="-1"></a>                                <span class="fu">st_geometry</span>(camden_oas))</span>
<span id="cb45-4"><a href="spatial-autocorrelation.html#cb45-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-5"><a href="spatial-autocorrelation.html#cb45-5" aria-hidden="true" tabindex="-1"></a><span class="co"># get the names (codes) of these neighbours</span></span>
<span id="cb45-6"><a href="spatial-autocorrelation.html#cb45-6" aria-hidden="true" tabindex="-1"></a>neighbour_names <span class="ot">&lt;-</span> camden_oas[chosen_oa_neighbours[[<span class="dv">1</span>]],]</span>
<span id="cb45-7"><a href="spatial-autocorrelation.html#cb45-7" aria-hidden="true" tabindex="-1"></a>neighbour_names <span class="ot">&lt;-</span> neighbour_names<span class="sc">$</span>OA11CD</span>
<span id="cb45-8"><a href="spatial-autocorrelation.html#cb45-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-9"><a href="spatial-autocorrelation.html#cb45-9" aria-hidden="true" tabindex="-1"></a><span class="co"># inspect</span></span>
<span id="cb45-10"><a href="spatial-autocorrelation.html#cb45-10" aria-hidden="true" tabindex="-1"></a><span class="fu">tm_shape</span>(camden_oas) <span class="sc">+</span> </span>
<span id="cb45-11"><a href="spatial-autocorrelation.html#cb45-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_borders</span>() <span class="sc">+</span></span>
<span id="cb45-12"><a href="spatial-autocorrelation.html#cb45-12" aria-hidden="true" tabindex="-1"></a>  <span class="co"># highlight only the neighbours</span></span>
<span id="cb45-13"><a href="spatial-autocorrelation.html#cb45-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_shape</span>(camden_oas[camden_oas<span class="sc">$</span>OA11CD <span class="sc">%in%</span> neighbour_names,]) <span class="sc">+</span> </span>
<span id="cb45-14"><a href="spatial-autocorrelation.html#cb45-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_fill</span>(<span class="at">col =</span> <span class="st">&#39;green&#39;</span>) <span class="sc">+</span></span>
<span id="cb45-15"><a href="spatial-autocorrelation.html#cb45-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_shape</span>(camden_oas[camden_oas<span class="sc">$</span>OA11CD<span class="sc">==</span>chosen_oa,]) <span class="sc">+</span> </span>
<span id="cb45-16"><a href="spatial-autocorrelation.html#cb45-16" aria-hidden="true" tabindex="-1"></a>  <span class="co"># highlight only the chosen OA</span></span>
<span id="cb45-17"><a href="spatial-autocorrelation.html#cb45-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_fill</span>(<span class="at">col =</span> <span class="st">&#39;red&#39;</span>) <span class="sc">+</span></span>
<span id="cb45-18"><a href="spatial-autocorrelation.html#cb45-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_shape</span>(camden_oas) <span class="sc">+</span> </span>
<span id="cb45-19"><a href="spatial-autocorrelation.html#cb45-19" aria-hidden="true" tabindex="-1"></a>  <span class="co"># overlay the borders</span></span>
<span id="cb45-20"><a href="spatial-autocorrelation.html#cb45-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_borders</span>(<span class="at">col=</span><span class="st">&#39;black&#39;</span>)</span></code></pre></div>
<p><img src="GEOG0114_files/figure-html/04-f-shared-boundary-neighbour-example-1.png" width="672" /></p>
<div class="note">
<p><strong>Note</strong><br/>
Because the tolerance of the shared boundaries in the <code>st_rook()</code> pattern and the <code>st_queen()</code> pattern, in this example they both assign the same neighbours. This is true for many non-square polygons as the difference is often given as whether two shapes share one or more points. Therefore the difference can have more to do with the resolution and alignment of your polygons than the actual spatial properties they represent. They can and do find different neighbours in other situations. Follow the grid example in the <code>st_relate()</code> documentation if you want to see it working.</p>
</div>
</div>
<div id="theft-in-camden" class="section level2" number="2.10">
<h2><span class="header-section-number">2.10</span> Theft in Camden</h2>
<p>Now that we have found the different ways of finding neighbours we can consider how they relate to one another. There are two ways of looking at spatial autocorrelation:</p>
<ul>
<li><strong>Global:</strong> This is a way of creating a metric of how regularly or irregularly clustered the variables are over the entire area studied.</li>
<li><strong>Local:</strong> This is the difference between an area and its neighbours. You would expect neighbours to be similar, but you can find exceptional places and results by seeing if places are quantifiably more like or dislike their neighbours than the average other place.</li>
</ul>
<p>But before we start that let’s get into the data we are going to use! We’ll be using personal theft data from around Camden. Our neighbourhood analysis of spatial autocorrelation should allow us to quantify the pattern of distribution of reported theft from persons in Camden in 2019.</p>
<div class="sourceCode" id="cb46"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb46-1"><a href="spatial-autocorrelation.html#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="co"># load theft data</span></span>
<span id="cb46-2"><a href="spatial-autocorrelation.html#cb46-2" aria-hidden="true" tabindex="-1"></a>camden_theft <span class="ot">&lt;-</span> <span class="fu">fread</span>(<span class="st">&#39;data/crime/2019_camden_theft_from_person.csv&#39;</span>)</span>
<span id="cb46-3"><a href="spatial-autocorrelation.html#cb46-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-4"><a href="spatial-autocorrelation.html#cb46-4" aria-hidden="true" tabindex="-1"></a><span class="co"># convert csv to sf object</span></span>
<span id="cb46-5"><a href="spatial-autocorrelation.html#cb46-5" aria-hidden="true" tabindex="-1"></a>camden_theft <span class="ot">&lt;-</span> <span class="fu">st_as_sf</span>(camden_theft, <span class="at">coords =</span> <span class="fu">c</span>(<span class="st">&#39;X&#39;</span>,<span class="st">&#39;Y&#39;</span>), <span class="at">crs =</span> <span class="dv">27700</span>)</span>
<span id="cb46-6"><a href="spatial-autocorrelation.html#cb46-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-7"><a href="spatial-autocorrelation.html#cb46-7" aria-hidden="true" tabindex="-1"></a><span class="co"># inspect</span></span>
<span id="cb46-8"><a href="spatial-autocorrelation.html#cb46-8" aria-hidden="true" tabindex="-1"></a><span class="fu">tm_shape</span>(camden_oas) <span class="sc">+</span></span>
<span id="cb46-9"><a href="spatial-autocorrelation.html#cb46-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_polygons</span>() <span class="sc">+</span></span>
<span id="cb46-10"><a href="spatial-autocorrelation.html#cb46-10" aria-hidden="true" tabindex="-1"></a><span class="fu">tm_shape</span>(camden_theft) <span class="sc">+</span></span>
<span id="cb46-11"><a href="spatial-autocorrelation.html#cb46-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_dots</span>()</span></code></pre></div>
<p><img src="GEOG0114_files/figure-html/04-g-loading-in-crime-data-1.png" width="672" /></p>
<p>This is point data, but we are interested in the polygons and how this data relates to the administrative boundaries it is within. Let’s count the number of thefts in each OA. This is a spatial operation that is often called “point in polygon”. As we are just counting the number of occurrences in each polygon it is quite easy. In the future you may often want to aggregate over points for an area, or in reverse assign values from the polygon to the points.</p>
<div class="sourceCode" id="cb47"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb47-1"><a href="spatial-autocorrelation.html#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="co"># thefts in camden</span></span>
<span id="cb47-2"><a href="spatial-autocorrelation.html#cb47-2" aria-hidden="true" tabindex="-1"></a>camden_oas<span class="sc">$</span>n_thefts <span class="ot">&lt;-</span> <span class="fu">lengths</span>(<span class="fu">st_intersects</span>(camden_oas, camden_theft))</span>
<span id="cb47-3"><a href="spatial-autocorrelation.html#cb47-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-4"><a href="spatial-autocorrelation.html#cb47-4" aria-hidden="true" tabindex="-1"></a><span class="co"># inspect</span></span>
<span id="cb47-5"><a href="spatial-autocorrelation.html#cb47-5" aria-hidden="true" tabindex="-1"></a><span class="fu">tm_shape</span>(camden_oas) <span class="sc">+</span></span>
<span id="cb47-6"><a href="spatial-autocorrelation.html#cb47-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_fill</span>(<span class="at">col=</span><span class="st">&#39;n_thefts&#39;</span>)</span></code></pre></div>
<p><img src="GEOG0114_files/figure-html/04-h-point-in-polygon-1.png" width="672" /></p>
<p>You can see our map isskewed by central London, meaning that the results in central London (the south of Camden) are so much larger than those in the north that it makes it harder to see the smaller differences between other areas. We’ll take the square root of the number of thefts to remedy this.</p>
<div class="sourceCode" id="cb48"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb48-1"><a href="spatial-autocorrelation.html#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="co"># square root of thefts</span></span>
<span id="cb48-2"><a href="spatial-autocorrelation.html#cb48-2" aria-hidden="true" tabindex="-1"></a>camden_oas<span class="sc">$</span>sqrt_n_thefts <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(camden_oas<span class="sc">$</span>n_thefts)</span>
<span id="cb48-3"><a href="spatial-autocorrelation.html#cb48-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-4"><a href="spatial-autocorrelation.html#cb48-4" aria-hidden="true" tabindex="-1"></a><span class="co"># inspect</span></span>
<span id="cb48-5"><a href="spatial-autocorrelation.html#cb48-5" aria-hidden="true" tabindex="-1"></a><span class="fu">tm_shape</span>(camden_oas) <span class="sc">+</span></span>
<span id="cb48-6"><a href="spatial-autocorrelation.html#cb48-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_fill</span>(<span class="at">col=</span><span class="st">&#39;sqrt_n_thefts&#39;</span>)</span></code></pre></div>
<p><img src="GEOG0114_files/figure-html/04-square-root-1.png" width="672" /></p>
<p>There: a slightly more nuanced picture</p>
</div>
<div id="global-morans-i" class="section level2" number="2.11">
<h2><span class="header-section-number">2.11</span> Global Moran’s I</h2>
<p>With a <a href="https://en.wikipedia.org/wiki/Moran%27s_I">Global Moran’s I</a> we can test how “random” the spatial distribution of these values is. Global Moran’s I is a metric between -1 and 1. -1 is a completely even spatial distribution of values, 0 is a “random” distribution, and 1 is a “non-random” distribution of clearly defined clusters.</p>
<p>To calculate the Global Moran’s I you need an adjacency matrix that contains the information of whether or not an OA is next to another. For an even more nuanced view you can include distance, or a distance weighting in the matrix rather than just the <code>TRUE</code> or <code>FALSE</code>, to take into account the strength of the neighbourhoodness. Because of the way Moran’s I functions in R it is necessary to use the <code>sp</code> and <code>spdep</code> libraries. So load them in.</p>
<div class="sourceCode" id="cb49"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb49-1"><a href="spatial-autocorrelation.html#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="co"># libraries</span></span>
<span id="cb49-2"><a href="spatial-autocorrelation.html#cb49-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sp)</span>
<span id="cb49-3"><a href="spatial-autocorrelation.html#cb49-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(spdep)</span></code></pre></div>
<pre><code>## Loading required package: spData</code></pre>
<p>As you will see these methods and functions have quite esoteric and complicated syntax. Some of the operations they will do will be similar to the examples shown earlier, but the way they assign and store variables makes it much quicker to run complex spatial operations.</p>
<div class="sourceCode" id="cb51"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb51-1"><a href="spatial-autocorrelation.html#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="co"># inspect</span></span>
<span id="cb51-2"><a href="spatial-autocorrelation.html#cb51-2" aria-hidden="true" tabindex="-1"></a><span class="fu">class</span>(camden_oas)</span></code></pre></div>
<pre><code>## [1] &quot;sf&quot;         &quot;data.frame&quot;</code></pre>
<div class="sourceCode" id="cb53"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb53-1"><a href="spatial-autocorrelation.html#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="co"># convert to sp</span></span>
<span id="cb53-2"><a href="spatial-autocorrelation.html#cb53-2" aria-hidden="true" tabindex="-1"></a>camden_oas_sp <span class="ot">&lt;-</span> <span class="fu">as_Spatial</span>(camden_oas, <span class="at">IDs=</span>camden_oas<span class="sc">$</span>OA11CD)</span>
<span id="cb53-3"><a href="spatial-autocorrelation.html#cb53-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-4"><a href="spatial-autocorrelation.html#cb53-4" aria-hidden="true" tabindex="-1"></a><span class="co"># inspect</span></span>
<span id="cb53-5"><a href="spatial-autocorrelation.html#cb53-5" aria-hidden="true" tabindex="-1"></a><span class="fu">class</span>(camden_oas_sp)</span></code></pre></div>
<pre><code>## [1] &quot;SpatialPolygonsDataFrame&quot;
## attr(,&quot;package&quot;)
## [1] &quot;sp&quot;</code></pre>
<p>Now we can make the esoteric and timesaving “nb” object in which we store for each OA which other OAs are considered to be neighbours.</p>
<div class="sourceCode" id="cb55"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb55-1"><a href="spatial-autocorrelation.html#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="co"># create an nb object</span></span>
<span id="cb55-2"><a href="spatial-autocorrelation.html#cb55-2" aria-hidden="true" tabindex="-1"></a>camden_oas_nb <span class="ot">&lt;-</span> <span class="fu">poly2nb</span>(camden_oas_sp, <span class="at">row.names=</span>camden_oas_sp<span class="sc">$</span>OA11CD)</span>
<span id="cb55-3"><a href="spatial-autocorrelation.html#cb55-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-4"><a href="spatial-autocorrelation.html#cb55-4" aria-hidden="true" tabindex="-1"></a><span class="co"># inspect</span></span>
<span id="cb55-5"><a href="spatial-autocorrelation.html#cb55-5" aria-hidden="true" tabindex="-1"></a><span class="fu">class</span>(camden_oas_nb)</span></code></pre></div>
<pre><code>## [1] &quot;nb&quot;</code></pre>
<div class="sourceCode" id="cb57"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb57-1"><a href="spatial-autocorrelation.html#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="co"># inspect</span></span>
<span id="cb57-2"><a href="spatial-autocorrelation.html#cb57-2" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(camden_oas_nb,<span class="at">list.len=</span><span class="dv">10</span>)</span></code></pre></div>
<pre><code>## List of 749
##  $ : int [1:7] 10 15 215 303 327 375 464
##  $ : int [1:5] 19 72 309 365 430
##  $ : int [1:3] 133 152 709
##  $ : int [1:7] 78 131 152 286 314 582 651
##  $ : int [1:5] 67 316 486 492 703
##  $ : int [1:8] 7 68 317 487 556 612 625 638
##  $ : int [1:3] 6 68 317
##  $ : int [1:7] 57 58 164 358 429 605 684
##  $ : int [1:5] 58 164 489 609 700
##  $ : int [1:7] 1 215 245 311 327 366 644
##   [list output truncated]
##  - attr(*, &quot;class&quot;)= chr &quot;nb&quot;
##  - attr(*, &quot;region.id&quot;)= chr [1:749] &quot;E00004395&quot; &quot;E00004314&quot; &quot;E00004578&quot; &quot;E00004579&quot; ...
##  - attr(*, &quot;call&quot;)= language poly2nb(pl = camden_oas_sp, row.names = camden_oas_sp$OA11CD)
##  - attr(*, &quot;type&quot;)= chr &quot;queen&quot;
##  - attr(*, &quot;sym&quot;)= logi TRUE</code></pre>
<p>Next, we need to assign weights to each neighbouring polygon. In our case, each neighbouring polygon will be assigned equal weight with <code>style='W'</code>. After this, we can calculate a value for the Global Moran’s I.</p>
<div class="sourceCode" id="cb59"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb59-1"><a href="spatial-autocorrelation.html#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="co"># create the list weights object</span></span>
<span id="cb59-2"><a href="spatial-autocorrelation.html#cb59-2" aria-hidden="true" tabindex="-1"></a>nb_weights_list <span class="ot">&lt;-</span> <span class="fu">nb2listw</span>(camden_oas_nb, <span class="at">style=</span><span class="st">&#39;W&#39;</span>)</span>
<span id="cb59-3"><a href="spatial-autocorrelation.html#cb59-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-4"><a href="spatial-autocorrelation.html#cb59-4" aria-hidden="true" tabindex="-1"></a><span class="co"># inspect</span></span>
<span id="cb59-5"><a href="spatial-autocorrelation.html#cb59-5" aria-hidden="true" tabindex="-1"></a><span class="fu">class</span>(nb_weights_list)</span></code></pre></div>
<pre><code>## [1] &quot;listw&quot; &quot;nb&quot;</code></pre>
<div class="sourceCode" id="cb61"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb61-1"><a href="spatial-autocorrelation.html#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Moran&#39;s I</span></span>
<span id="cb61-2"><a href="spatial-autocorrelation.html#cb61-2" aria-hidden="true" tabindex="-1"></a>mi_value <span class="ot">&lt;-</span> <span class="fu">moran</span>(camden_oas_sp<span class="sc">$</span>n_thefts,nb_weights_list,<span class="at">n=</span><span class="fu">length</span>(nb_weights_list<span class="sc">$</span>neighbours),<span class="at">S0=</span><span class="fu">Szero</span>(nb_weights_list))</span>
<span id="cb61-3"><a href="spatial-autocorrelation.html#cb61-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-4"><a href="spatial-autocorrelation.html#cb61-4" aria-hidden="true" tabindex="-1"></a><span class="co"># inspect</span></span>
<span id="cb61-5"><a href="spatial-autocorrelation.html#cb61-5" aria-hidden="true" tabindex="-1"></a>mi_value</span></code></pre></div>
<pre><code>## $I
## [1] 0.4772137
## 
## $K
## [1] 75.21583</code></pre>
<p>The Global Moran’s I seems to indicate that there is indeed some spatial autocorrelation in our data, however, this is just a quick way to check the score. To do so properly we need to compare our score a randomly distributed version of the variables. We can do this by using something called a <a href="https://en.wikipedia.org/wiki/Monte_Carlo_method">Monte Carlo simulation</a>.</p>
<div class="sourceCode" id="cb63"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb63-1"><a href="spatial-autocorrelation.html#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="co"># run a Monte Carlo simulation 599 times</span></span>
<span id="cb63-2"><a href="spatial-autocorrelation.html#cb63-2" aria-hidden="true" tabindex="-1"></a>mc_model <span class="ot">&lt;-</span> <span class="fu">moran.mc</span>(camden_oas_sp<span class="sc">$</span>n_thefts, nb_weights_list, <span class="at">nsim=</span><span class="dv">599</span>)</span>
<span id="cb63-3"><a href="spatial-autocorrelation.html#cb63-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-4"><a href="spatial-autocorrelation.html#cb63-4" aria-hidden="true" tabindex="-1"></a><span class="co"># inspect</span></span>
<span id="cb63-5"><a href="spatial-autocorrelation.html#cb63-5" aria-hidden="true" tabindex="-1"></a>mc_model</span></code></pre></div>
<pre><code>## 
##  Monte-Carlo simulation of Moran I
## 
## data:  camden_oas_sp$n_thefts 
## weights: nb_weights_list  
## number of simulations + 1: 600 
## 
## statistic = 0.47721, observed rank = 600, p-value = 0.001667
## alternative hypothesis: greater</code></pre>
<p>This model shows that our distribution of thefts differs significantly from a random distribution. As such, we can conclude that there is significant spatial autocorrelation in our theft data set.</p>
</div>
<div id="local-morans-i" class="section level2" number="2.12">
<h2><span class="header-section-number">2.12</span> Local Moran’s I</h2>
<p>With a measurement of local spatial autocorrelation we could find hotspots of theft that are surrounded by areas of much lower theft. According to the previous global statistic these are not randomly distributed pockets but would be outliers against the general trend of clusteredness! These could be areas that contain very specific locations, where interventions could be made that drastically reduce the rate of crime rather than other areas where there is a high level of ambient crime.</p>
<div class="sourceCode" id="cb65"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb65-1"><a href="spatial-autocorrelation.html#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="co"># create an nb object</span></span>
<span id="cb65-2"><a href="spatial-autocorrelation.html#cb65-2" aria-hidden="true" tabindex="-1"></a>camden_oas_nb <span class="ot">&lt;-</span> <span class="fu">poly2nb</span>(camden_oas_sp, <span class="at">row.names=</span>camden_oas_sp<span class="sc">$</span>OA11CD)</span>
<span id="cb65-3"><a href="spatial-autocorrelation.html#cb65-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-4"><a href="spatial-autocorrelation.html#cb65-4" aria-hidden="true" tabindex="-1"></a><span class="co"># create the list weights object</span></span>
<span id="cb65-5"><a href="spatial-autocorrelation.html#cb65-5" aria-hidden="true" tabindex="-1"></a>nb_weights_list <span class="ot">&lt;-</span> <span class="fu">nb2listw</span>(camden_oas_nb, <span class="at">style=</span><span class="st">&#39;W&#39;</span>)</span>
<span id="cb65-6"><a href="spatial-autocorrelation.html#cb65-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-7"><a href="spatial-autocorrelation.html#cb65-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Local Moran&#39;s I</span></span>
<span id="cb65-8"><a href="spatial-autocorrelation.html#cb65-8" aria-hidden="true" tabindex="-1"></a>local_moran_camden_oa_theft <span class="ot">&lt;-</span> <span class="fu">localmoran</span>(camden_oas_sp<span class="sc">$</span>n_thefts, nb_weights_list)</span></code></pre></div>
<p>To properly utilise these local statistics and make an intuitively useful map, we need to combine them with our crime count variable. Because of the way the new variable will be calculated, we first need to rescale our variable so that the mean is 0.</p>
<div class="sourceCode" id="cb66"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb66-1"><a href="spatial-autocorrelation.html#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="co"># rescale</span></span>
<span id="cb66-2"><a href="spatial-autocorrelation.html#cb66-2" aria-hidden="true" tabindex="-1"></a>camden_oas_sp<span class="sc">$</span>scale_n_thefts <span class="ot">&lt;-</span> <span class="fu">scale</span>(camden_oas_sp<span class="sc">$</span>n_thefts)</span></code></pre></div>
<p>To compare this rescaled value against its neighbours, we subsequently need to create a new column that carries information about the neighbours. This is called a spatial lag function. The “lag” just refers to the fact you are comparing one observation against another, this can also be used between timed observations. In this case, the “lag” we are looking at is between neighbours.</p>
<div class="sourceCode" id="cb67"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb67-1"><a href="spatial-autocorrelation.html#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="co"># create a spatial lag variable </span></span>
<span id="cb67-2"><a href="spatial-autocorrelation.html#cb67-2" aria-hidden="true" tabindex="-1"></a>camden_oas_sp<span class="sc">$</span>lag_scale_n_thefts <span class="ot">&lt;-</span> <span class="fu">lag.listw</span>(nb_weights_list, camden_oas_sp<span class="sc">$</span>scale_n_thefts)</span></code></pre></div>
<p>Now we have used <code>sp</code> for all it is worth it’s time to head back to the safety of <code>sf()</code> before exploring any forms of more localised patterns.</p>
<div class="sourceCode" id="cb68"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb68-1"><a href="spatial-autocorrelation.html#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="co"># convert to sf</span></span>
<span id="cb68-2"><a href="spatial-autocorrelation.html#cb68-2" aria-hidden="true" tabindex="-1"></a>camden_oas_moran_stats <span class="ot">&lt;-</span> <span class="fu">st_as_sf</span>(camden_oas_sp)</span></code></pre></div>
<p>To make a human readable version of the map we will generate some labels for our findings from the <a href="https://en.wikipedia.org/wiki/Indicators_of_spatial_association">Local Moran’s I</a> stats. This process calculates what the value of each polygon is compared to its neighbours and works out if they are similar or dissimilar and in which way, then gives them a text label to describe the relationship.</p>
<div class="sourceCode" id="cb69"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb69-1"><a href="spatial-autocorrelation.html#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="co"># set a significance value</span></span>
<span id="cb69-2"><a href="spatial-autocorrelation.html#cb69-2" aria-hidden="true" tabindex="-1"></a>sig_level <span class="ot">&lt;-</span> <span class="fl">0.1</span></span>
<span id="cb69-3"><a href="spatial-autocorrelation.html#cb69-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-4"><a href="spatial-autocorrelation.html#cb69-4" aria-hidden="true" tabindex="-1"></a><span class="co"># classification with significance value</span></span>
<span id="cb69-5"><a href="spatial-autocorrelation.html#cb69-5" aria-hidden="true" tabindex="-1"></a>camden_oas_moran_stats<span class="sc">$</span>quad_sig <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(camden_oas_moran_stats<span class="sc">$</span>scale_n_thefts <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">&amp;</span> </span>
<span id="cb69-6"><a href="spatial-autocorrelation.html#cb69-6" aria-hidden="true" tabindex="-1"></a>                                          camden_oas_moran_stats<span class="sc">$</span>lag_scale_n_thefts <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">&amp;</span> </span>
<span id="cb69-7"><a href="spatial-autocorrelation.html#cb69-7" aria-hidden="true" tabindex="-1"></a>                                          local_moran_camden_oa_theft[,<span class="dv">5</span>] <span class="sc">&lt;=</span> sig_level, </span>
<span id="cb69-8"><a href="spatial-autocorrelation.html#cb69-8" aria-hidden="true" tabindex="-1"></a>                                          <span class="st">&#39;high-high&#39;</span>, </span>
<span id="cb69-9"><a href="spatial-autocorrelation.html#cb69-9" aria-hidden="true" tabindex="-1"></a>                                   <span class="fu">ifelse</span>(camden_oas_moran_stats<span class="sc">$</span>scale_n_thefts <span class="sc">&lt;=</span> <span class="dv">0</span> <span class="sc">&amp;</span> </span>
<span id="cb69-10"><a href="spatial-autocorrelation.html#cb69-10" aria-hidden="true" tabindex="-1"></a>                                          camden_oas_moran_stats<span class="sc">$</span>lag_scale_n_thefts <span class="sc">&lt;=</span> <span class="dv">0</span> <span class="sc">&amp;</span> </span>
<span id="cb69-11"><a href="spatial-autocorrelation.html#cb69-11" aria-hidden="true" tabindex="-1"></a>                                          local_moran_camden_oa_theft[,<span class="dv">5</span>] <span class="sc">&lt;=</span> sig_level, </span>
<span id="cb69-12"><a href="spatial-autocorrelation.html#cb69-12" aria-hidden="true" tabindex="-1"></a>                                          <span class="st">&#39;low-low&#39;</span>, </span>
<span id="cb69-13"><a href="spatial-autocorrelation.html#cb69-13" aria-hidden="true" tabindex="-1"></a>                                   <span class="fu">ifelse</span>(camden_oas_moran_stats<span class="sc">$</span>scale_n_thefts <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">&amp;</span> </span>
<span id="cb69-14"><a href="spatial-autocorrelation.html#cb69-14" aria-hidden="true" tabindex="-1"></a>                                          camden_oas_moran_stats<span class="sc">$</span>lag_scale_n_thefts <span class="sc">&lt;=</span> <span class="dv">0</span> <span class="sc">&amp;</span> </span>
<span id="cb69-15"><a href="spatial-autocorrelation.html#cb69-15" aria-hidden="true" tabindex="-1"></a>                                          local_moran_camden_oa_theft[,<span class="dv">5</span>] <span class="sc">&lt;=</span> sig_level, </span>
<span id="cb69-16"><a href="spatial-autocorrelation.html#cb69-16" aria-hidden="true" tabindex="-1"></a>                                          <span class="st">&#39;high-low&#39;</span>, </span>
<span id="cb69-17"><a href="spatial-autocorrelation.html#cb69-17" aria-hidden="true" tabindex="-1"></a>                                   <span class="fu">ifelse</span>(camden_oas_moran_stats<span class="sc">$</span>scale_n_thefts <span class="sc">&lt;=</span> <span class="dv">0</span> <span class="sc">&amp;</span> </span>
<span id="cb69-18"><a href="spatial-autocorrelation.html#cb69-18" aria-hidden="true" tabindex="-1"></a>                                          camden_oas_moran_stats<span class="sc">$</span>lag_scale_n_thefts <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">&amp;</span> </span>
<span id="cb69-19"><a href="spatial-autocorrelation.html#cb69-19" aria-hidden="true" tabindex="-1"></a>                                          local_moran_camden_oa_theft[,<span class="dv">5</span>] <span class="sc">&lt;=</span> sig_level, </span>
<span id="cb69-20"><a href="spatial-autocorrelation.html#cb69-20" aria-hidden="true" tabindex="-1"></a>                                          <span class="st">&#39;low-high&#39;</span>,</span>
<span id="cb69-21"><a href="spatial-autocorrelation.html#cb69-21" aria-hidden="true" tabindex="-1"></a>                                   <span class="fu">ifelse</span>(local_moran_camden_oa_theft[,<span class="dv">5</span>] <span class="sc">&gt;</span> sig_level, </span>
<span id="cb69-22"><a href="spatial-autocorrelation.html#cb69-22" aria-hidden="true" tabindex="-1"></a>                                          <span class="st">&#39;not-significant&#39;</span>, </span>
<span id="cb69-23"><a href="spatial-autocorrelation.html#cb69-23" aria-hidden="true" tabindex="-1"></a>                                          <span class="st">&#39;not-significant&#39;</span>)))))</span>
<span id="cb69-24"><a href="spatial-autocorrelation.html#cb69-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-25"><a href="spatial-autocorrelation.html#cb69-25" aria-hidden="true" tabindex="-1"></a><span class="co"># classification without significance value</span></span>
<span id="cb69-26"><a href="spatial-autocorrelation.html#cb69-26" aria-hidden="true" tabindex="-1"></a>camden_oas_moran_stats<span class="sc">$</span>quad_non_sig <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(camden_oas_moran_stats<span class="sc">$</span>scale_n_thefts <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">&amp;</span> </span>
<span id="cb69-27"><a href="spatial-autocorrelation.html#cb69-27" aria-hidden="true" tabindex="-1"></a>                                              camden_oas_moran_stats<span class="sc">$</span>lag_scale_n_thefts <span class="sc">&gt;</span> <span class="dv">0</span>, </span>
<span id="cb69-28"><a href="spatial-autocorrelation.html#cb69-28" aria-hidden="true" tabindex="-1"></a>                                              <span class="st">&#39;high-high&#39;</span>, </span>
<span id="cb69-29"><a href="spatial-autocorrelation.html#cb69-29" aria-hidden="true" tabindex="-1"></a>                                       <span class="fu">ifelse</span>(camden_oas_moran_stats<span class="sc">$</span>scale_n_thefts <span class="sc">&lt;=</span> <span class="dv">0</span> <span class="sc">&amp;</span> </span>
<span id="cb69-30"><a href="spatial-autocorrelation.html#cb69-30" aria-hidden="true" tabindex="-1"></a>                                              camden_oas_moran_stats<span class="sc">$</span>lag_scale_n_thefts <span class="sc">&lt;=</span> <span class="dv">0</span>, </span>
<span id="cb69-31"><a href="spatial-autocorrelation.html#cb69-31" aria-hidden="true" tabindex="-1"></a>                                              <span class="st">&#39;low-low&#39;</span>, </span>
<span id="cb69-32"><a href="spatial-autocorrelation.html#cb69-32" aria-hidden="true" tabindex="-1"></a>                                       <span class="fu">ifelse</span>(camden_oas_moran_stats<span class="sc">$</span>scale_n_thefts <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">&amp;</span> </span>
<span id="cb69-33"><a href="spatial-autocorrelation.html#cb69-33" aria-hidden="true" tabindex="-1"></a>                                              camden_oas_moran_stats<span class="sc">$</span>lag_scale_n_thefts <span class="sc">&lt;=</span> <span class="dv">0</span>, </span>
<span id="cb69-34"><a href="spatial-autocorrelation.html#cb69-34" aria-hidden="true" tabindex="-1"></a>                                              <span class="st">&#39;high-low&#39;</span>, </span>
<span id="cb69-35"><a href="spatial-autocorrelation.html#cb69-35" aria-hidden="true" tabindex="-1"></a>                                       <span class="fu">ifelse</span>(camden_oas_moran_stats<span class="sc">$</span>scale_n_thefts <span class="sc">&lt;=</span> <span class="dv">0</span> <span class="sc">&amp;</span> </span>
<span id="cb69-36"><a href="spatial-autocorrelation.html#cb69-36" aria-hidden="true" tabindex="-1"></a>                                              camden_oas_moran_stats<span class="sc">$</span>lag_scale_n_thefts <span class="sc">&gt;</span> <span class="dv">0</span>,</span>
<span id="cb69-37"><a href="spatial-autocorrelation.html#cb69-37" aria-hidden="true" tabindex="-1"></a>                                              <span class="st">&#39;low-high&#39;</span>,<span class="cn">NA</span>))))</span></code></pre></div>
<p>To understand how this is working we can look at the data non-spatially. As we rescaled the data, our axes should split the data neatly into their different area vs spatial lag relationship categories. Let’s make the scatterplot using the scaled number of thefts for the areas in the x axis and their spatially lagged results in the y axis.</p>
<div class="sourceCode" id="cb70"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb70-1"><a href="spatial-autocorrelation.html#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="co"># plot the results without the statistical significance</span></span>
<span id="cb70-2"><a href="spatial-autocorrelation.html#cb70-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(camden_oas_moran_stats, <span class="fu">aes</span>(<span class="at">x =</span> scale_n_thefts, </span>
<span id="cb70-3"><a href="spatial-autocorrelation.html#cb70-3" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">y =</span> lag_scale_n_thefts, </span>
<span id="cb70-4"><a href="spatial-autocorrelation.html#cb70-4" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">color =</span> quad_non_sig)) <span class="sc">+</span></span>
<span id="cb70-5"><a href="spatial-autocorrelation.html#cb70-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">0</span>) <span class="sc">+</span> <span class="co"># plot vertical line</span></span>
<span id="cb70-6"><a href="spatial-autocorrelation.html#cb70-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>) <span class="sc">+</span> <span class="co"># plot horizontal line</span></span>
<span id="cb70-7"><a href="spatial-autocorrelation.html#cb70-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">&#39;Scaled Thefts (n)&#39;</span>) <span class="sc">+</span></span>
<span id="cb70-8"><a href="spatial-autocorrelation.html#cb70-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">&#39;Lagged Scaled Thefts (n)&#39;</span>) <span class="sc">+</span></span>
<span id="cb70-9"><a href="spatial-autocorrelation.html#cb70-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">colour=</span><span class="st">&#39;Relative to neighbours&#39;</span>) <span class="sc">+</span></span>
<span id="cb70-10"><a href="spatial-autocorrelation.html#cb70-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>()</span></code></pre></div>
<p><img src="GEOG0114_files/figure-html/04-v-plotting-quadrants-scatter-1.png" width="672" /></p>
<div class="sourceCode" id="cb71"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb71-1"><a href="spatial-autocorrelation.html#cb71-1" aria-hidden="true" tabindex="-1"></a><span class="co"># plot the results with the statistical significance</span></span>
<span id="cb71-2"><a href="spatial-autocorrelation.html#cb71-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(camden_oas_moran_stats, <span class="fu">aes</span>(<span class="at">x =</span> scale_n_thefts, </span>
<span id="cb71-3"><a href="spatial-autocorrelation.html#cb71-3" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">y =</span> lag_scale_n_thefts, </span>
<span id="cb71-4"><a href="spatial-autocorrelation.html#cb71-4" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">color =</span> quad_sig)) <span class="sc">+</span></span>
<span id="cb71-5"><a href="spatial-autocorrelation.html#cb71-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">0</span>) <span class="sc">+</span> <span class="co"># plot vertical line</span></span>
<span id="cb71-6"><a href="spatial-autocorrelation.html#cb71-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>) <span class="sc">+</span> <span class="co"># plot horizontal line</span></span>
<span id="cb71-7"><a href="spatial-autocorrelation.html#cb71-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">&#39;Scaled Thefts (n)&#39;</span>) <span class="sc">+</span></span>
<span id="cb71-8"><a href="spatial-autocorrelation.html#cb71-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">&#39;Lagged Scaled Thefts (n)&#39;</span>) <span class="sc">+</span></span>
<span id="cb71-9"><a href="spatial-autocorrelation.html#cb71-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">colour=</span><span class="st">&#39;Relative to neighbours&#39;</span>) <span class="sc">+</span></span>
<span id="cb71-10"><a href="spatial-autocorrelation.html#cb71-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>()</span></code></pre></div>
<p><img src="GEOG0114_files/figure-html/04-v-plotting-quadrants-scatter-2.png" width="672" /></p>
<p>Now let’s see how they are arranged spatially.</p>
<div class="sourceCode" id="cb72"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb72-1"><a href="spatial-autocorrelation.html#cb72-1" aria-hidden="true" tabindex="-1"></a><span class="co"># map all of the results here</span></span>
<span id="cb72-2"><a href="spatial-autocorrelation.html#cb72-2" aria-hidden="true" tabindex="-1"></a><span class="fu">tm_shape</span>(camden_oas_moran_stats) <span class="sc">+</span></span>
<span id="cb72-3"><a href="spatial-autocorrelation.html#cb72-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_fill</span>(<span class="at">col =</span> <span class="st">&#39;quad_non_sig&#39;</span>)</span></code></pre></div>
<p><img src="GEOG0114_files/figure-html/04-s-mapping-local-moran-1.png" width="672" /></p>
<div class="sourceCode" id="cb73"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb73-1"><a href="spatial-autocorrelation.html#cb73-1" aria-hidden="true" tabindex="-1"></a><span class="co"># map only the statistically significant results here</span></span>
<span id="cb73-2"><a href="spatial-autocorrelation.html#cb73-2" aria-hidden="true" tabindex="-1"></a><span class="fu">tm_shape</span>(camden_oas_moran_stats) <span class="sc">+</span></span>
<span id="cb73-3"><a href="spatial-autocorrelation.html#cb73-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_fill</span>(<span class="at">col =</span> <span class="st">&#39;quad_sig&#39;</span>)</span></code></pre></div>
<p><img src="GEOG0114_files/figure-html/04-s-mapping-local-moran-2.png" width="672" /></p>
<p>As our data are so spatially clustered we can’t see any outlier places (once we have ignored the non-significant results). This suggests that the pattern of theft from persons is not highly concentrated in very small areas or particular Output Areas, and instead is spread on a larger scale than we have used here. To go further than we have today it would be possible to run the exact same code but using a larger scale, perhaps LSOA, or Ward, and compare how this changes the Moran’s I statistics globally and locally. Or, to gain statistical significance in looking at the difference between areas getting more data perhaps over a longer timescale, where there are less areas with 0 thefts.</p>
</div>
<div id="tidy-data" class="section level2" number="2.13">
<h2><span class="header-section-number">2.13</span> Tidy data</h2>
<p>In this <strong>bonus</strong> part of this week’s session we will start by creating a <strong>tidy data set</strong> using some data from the <a href="https://www.ons.gov.uk/census/2011census">UK 2011 Census of Population</a>. As explained in the lecture, tidy data refers to a consistent way to structure your data in R. Tidy data, as formalised by <a href="http://hadley.nz/">R Wizard Hadley Wickham</a> in his contribution to the <a href="http://www.jstatsoft.org/v59/i10/paper">Journal of Statistical Software</a> is not only very much at the core of the <code>tidyverse</code> R package, but also of general importance when organising your data.</p>
<p>You can represent the same underlying data in multiple ways. The example below, taken from the the <code>tidyverse</code> package and described in the <a href="https://r4ds.had.co.nz/tidy-data.html">R for Data Science</a> book, shows that the same data can organised in four different ways.</p>
<div class="sourceCode" id="cb74"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb74-1"><a href="spatial-autocorrelation.html#cb74-1" aria-hidden="true" tabindex="-1"></a><span class="co"># load the tidyverse </span></span>
<span id="cb74-2"><a href="spatial-autocorrelation.html#cb74-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span></code></pre></div>
<p>Table <strong>1</strong>:</p>
<div class="sourceCode" id="cb75"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb75-1"><a href="spatial-autocorrelation.html#cb75-1" aria-hidden="true" tabindex="-1"></a>table1</span></code></pre></div>
<pre><code>## # A tibble: 6 × 4
##   country      year  cases population
##   &lt;chr&gt;       &lt;int&gt;  &lt;int&gt;      &lt;int&gt;
## 1 Afghanistan  1999    745   19987071
## 2 Afghanistan  2000   2666   20595360
## 3 Brazil       1999  37737  172006362
## 4 Brazil       2000  80488  174504898
## 5 China        1999 212258 1272915272
## 6 China        2000 213766 1280428583</code></pre>
<p>Table <strong>2</strong>:</p>
<div class="sourceCode" id="cb77"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb77-1"><a href="spatial-autocorrelation.html#cb77-1" aria-hidden="true" tabindex="-1"></a>table2</span></code></pre></div>
<pre><code>## # A tibble: 12 × 4
##    country      year type            count
##    &lt;chr&gt;       &lt;int&gt; &lt;chr&gt;           &lt;int&gt;
##  1 Afghanistan  1999 cases             745
##  2 Afghanistan  1999 population   19987071
##  3 Afghanistan  2000 cases            2666
##  4 Afghanistan  2000 population   20595360
##  5 Brazil       1999 cases           37737
##  6 Brazil       1999 population  172006362
##  7 Brazil       2000 cases           80488
##  8 Brazil       2000 population  174504898
##  9 China        1999 cases          212258
## 10 China        1999 population 1272915272
## 11 China        2000 cases          213766
## 12 China        2000 population 1280428583</code></pre>
<p>Table <strong>3</strong>:</p>
<div class="sourceCode" id="cb79"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb79-1"><a href="spatial-autocorrelation.html#cb79-1" aria-hidden="true" tabindex="-1"></a>table3</span></code></pre></div>
<pre><code>## # A tibble: 6 × 3
##   country      year rate             
## * &lt;chr&gt;       &lt;int&gt; &lt;chr&gt;            
## 1 Afghanistan  1999 745/19987071     
## 2 Afghanistan  2000 2666/20595360    
## 3 Brazil       1999 37737/172006362  
## 4 Brazil       2000 80488/174504898  
## 5 China        1999 212258/1272915272
## 6 China        2000 213766/1280428583</code></pre>
<p>Table <strong>4a</strong>:</p>
<div class="sourceCode" id="cb81"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb81-1"><a href="spatial-autocorrelation.html#cb81-1" aria-hidden="true" tabindex="-1"></a>table4a</span></code></pre></div>
<pre><code>## # A tibble: 3 × 3
##   country     `1999` `2000`
## * &lt;chr&gt;        &lt;int&gt;  &lt;int&gt;
## 1 Afghanistan    745   2666
## 2 Brazil       37737  80488
## 3 China       212258 213766</code></pre>
<p>Table <strong>4b</strong>:</p>
<div class="sourceCode" id="cb83"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb83-1"><a href="spatial-autocorrelation.html#cb83-1" aria-hidden="true" tabindex="-1"></a>table4b</span></code></pre></div>
<pre><code>## # A tibble: 3 × 3
##   country         `1999`     `2000`
## * &lt;chr&gt;            &lt;int&gt;      &lt;int&gt;
## 1 Afghanistan   19987071   20595360
## 2 Brazil       172006362  174504898
## 3 China       1272915272 1280428583</code></pre>
<p>None of these representations are wrong per se, however, not are equally easy to use. Only Table <strong>1</strong> can be considered as tidy data because it is the only table that adheres to the three rules that make a data set tidy:</p>
<ol style="list-style-type: decimal">
<li>Each variable must have its own column.</li>
<li>Each observation must have its own row.</li>
<li>Each value must have its own cell.</li>
</ol>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:04-figure-hadley-wickham"></span>
<img src="images/week04/04_a_tidy_data.png" alt="A visual representation of tidy data by [Hadley Wickham](https://r4ds.had.co.nz/tidy-data.html)." width="960" />
<p class="caption">
Figure 2.1: A visual representation of tidy data by <a href="https://r4ds.had.co.nz/tidy-data.html">Hadley Wickham</a>.
</p>
</div>
<p>Fortunately, there are some functions in the <code>tidyr</code> and <code>dplyr</code> packages, both part of the <code>tidyverse</code> that will help us cleaning and preparing our data sets to create a <strong>tidy data set</strong>. The most important and useful functions are:</p>
<table>
<thead>
<tr class="header">
<th align="left">Package</th>
<th align="left">Function</th>
<th align="left">Use to</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">dplyr</td>
<td align="left">select</td>
<td align="left">select columns</td>
</tr>
<tr class="even">
<td align="left">dplyr</td>
<td align="left">filter</td>
<td align="left">select rows</td>
</tr>
<tr class="odd">
<td align="left">dplyr</td>
<td align="left">mutate</td>
<td align="left">transform or recode variables</td>
</tr>
<tr class="even">
<td align="left">dplyr</td>
<td align="left">summarise</td>
<td align="left">summarise data</td>
</tr>
<tr class="odd">
<td align="left">dplyr</td>
<td align="left">group by</td>
<td align="left">group data into subgropus for further processing</td>
</tr>
<tr class="even">
<td align="left">tidyr</td>
<td align="left">pivot_longer</td>
<td align="left">convert data from wide format to long format</td>
</tr>
<tr class="odd">
<td align="left">tidyr</td>
<td align="left">pivot_wider</td>
<td align="left">convert long format data set to wide format</td>
</tr>
</tbody>
</table>
<div class="note">
<p><strong>Note</strong><br/>
Remember that when you encounter a function in a piece of R code that you have not seen before and you are wondering what it does that you can get access the documentation through <code>?name_of_function</code>, e.g. <code>?pivot_longer</code>. For almost any R package, the documentation contains a list of arguments that the function takes, in which format the functions expects these arguments, as well as a set of usage examples.</p>
</div>
<p>Now we know what constitute <strong>tidy data</strong>, we can put this into practice with an example using some data from the <a href="https://www.ons.gov.uk/">Office for National Statistics</a>. Let’s say we are requested to analyse some data on the ethnic background of the UK population, for instance, because we want to get some insights into the relationship between <a href="https://www.theguardian.com/world/2020/oct/09/bame-groups-hit-hard-again-covid-second-wave-grips-uk-nations">COVID-19 and ethnic background</a>. Our assignment is to calculate the relative proportions of each ethnic group within the administrative geography of the <a href="https://www.ons.gov.uk/peoplepopulationandcommunity/populationandmigration/populationestimates/datasets/middlesuperoutputareamidyearpopulationestimates">Middle layer Super Output Area (MSOA)</a>. In order to do this, we have access to a file that contains data on ethnicity by age group at the MSOA-level of every person in the 2011 UK Census who is 16 year or older. Download the file to your own computer and set up your data directory as usual.</p>
<div class="note">
<p><strong>Note</strong><br/>
Make sure that after downloading you first unzip the data, for instance, using <a href="https://www.7-zip.org/">7-Zip</a> on Windows or using <a href="https://theunarchiver.com/">The Unarchiver</a> on Mac OS.</p>
</div>
<div id="file-download-2" class="section level4 unnumbered">
<h4>File download</h4>
<table>
<thead>
<tr class="header">
<th align="left">File</th>
<th align="left">Type</th>
<th align="left">Link</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">Ethnicity by age group 2011 Census of Population</td>
<td align="left"><code>csv</code></td>
<td align="left"><a href="https://github.com/jtvandijk/GEOG0114/tree/master/data/zip/msoa_eth2011_ew_16plus.zip">Download</a></td>
</tr>
</tbody>
</table>
<p>We start by making sure our <code>tidyverse</code> is loaded into R and using the <code>read_csv()</code> function to read our <code>csv</code> file.</p>
<div class="sourceCode" id="cb85"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb85-1"><a href="spatial-autocorrelation.html#cb85-1" aria-hidden="true" tabindex="-1"></a><span class="co"># load the tidyverse </span></span>
<span id="cb85-2"><a href="spatial-autocorrelation.html#cb85-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb85-3"><a href="spatial-autocorrelation.html#cb85-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-4"><a href="spatial-autocorrelation.html#cb85-4" aria-hidden="true" tabindex="-1"></a><span class="co"># read data into dataframe</span></span>
<span id="cb85-5"><a href="spatial-autocorrelation.html#cb85-5" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">&#39;data/population/msoa_eth2011_ew_16plus.csv&#39;</span>)</span>
<span id="cb85-6"><a href="spatial-autocorrelation.html#cb85-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb85-7"><a href="spatial-autocorrelation.html#cb85-7" aria-hidden="true" tabindex="-1"></a><span class="co"># inspect the dataframe: number of columns</span></span>
<span id="cb85-8"><a href="spatial-autocorrelation.html#cb85-8" aria-hidden="true" tabindex="-1"></a><span class="fu">ncol</span>(df)</span></code></pre></div>
<pre><code>## [1] 385</code></pre>
<div class="sourceCode" id="cb87"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb87-1"><a href="spatial-autocorrelation.html#cb87-1" aria-hidden="true" tabindex="-1"></a><span class="co"># inspect the dataframe: number of rows</span></span>
<span id="cb87-2"><a href="spatial-autocorrelation.html#cb87-2" aria-hidden="true" tabindex="-1"></a><span class="fu">nrow</span>(df)</span></code></pre></div>
<pre><code>## [1] 7201</code></pre>
<div class="sourceCode" id="cb89"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb89-1"><a href="spatial-autocorrelation.html#cb89-1" aria-hidden="true" tabindex="-1"></a><span class="co"># inspect the dataframe: sneak peak</span></span>
<span id="cb89-2"><a href="spatial-autocorrelation.html#cb89-2" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(df, <span class="at">n_extra=</span><span class="dv">2</span>)</span></code></pre></div>
<pre><code>## Warning: The `n_extra` argument of `print()` is deprecated as of pillar 1.6.2.
## Please use the `max_extra_cols` argument instead.</code></pre>
<pre><code>## # A tibble: 7,201 × 385
##    msoa11cd  `Sex: All perso… `Sex: All perso… `Sex: All perso… `Sex: All perso…
##    &lt;chr&gt;                &lt;dbl&gt;            &lt;dbl&gt;            &lt;dbl&gt;            &lt;dbl&gt;
##  1 E02002559              215              206              204                0
##  2 E02002560              175              170              168                1
##  3 E02002561              140              128              128                0
##  4 E02002562              160              155              154                0
##  5 E02002563              132              130              130                0
##  6 E02002564              270              263              261                0
##  7 E02002565              124              119              117                0
##  8 E02002566              150              125              117                0
##  9 E02002567              178              166              159                0
## 10 E02002568              162              159              157                0
## # … with 7,191 more rows, and 380 more variables:
## #   Sex: All persons; Age: Age 16 to 17; Ethnic Group: White: Gypsy or Irish Traveller; measures: Value &lt;dbl&gt;,
## #   Sex: All persons; Age: Age 16 to 17; Ethnic Group: White: Other White; measures: Value &lt;dbl&gt;,
## #   …</code></pre>
<p>Because the data are split out over multiple columns, it is clear that the data are not directly suitable to establish the proportion of each ethnic group within the population of each MSOA. Let’s inspect the names of the columns to get a better idea of the structure of our data set.</p>
<div class="sourceCode" id="cb92"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb92-1"><a href="spatial-autocorrelation.html#cb92-1" aria-hidden="true" tabindex="-1"></a><span class="co"># inspect the dataframe: column names</span></span>
<span id="cb92-2"><a href="spatial-autocorrelation.html#cb92-2" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(df)</span></code></pre></div>
<pre><code>##  [1] &quot;msoa11cd&quot;                                                                                                                  
##  [2] &quot;Sex: All persons; Age: Age 16 to 17; Ethnic Group: All categories: Ethnic group; measures: Value&quot;                          
##  [3] &quot;Sex: All persons; Age: Age 16 to 17; Ethnic Group: White: Total; measures: Value&quot;                                          
##  [4] &quot;Sex: All persons; Age: Age 16 to 17; Ethnic Group: White: English/Welsh/Scottish/Northern Irish/British; measures: Value&quot;  
##  [5] &quot;Sex: All persons; Age: Age 16 to 17; Ethnic Group: White: Irish; measures: Value&quot;                                          
##  [6] &quot;Sex: All persons; Age: Age 16 to 17; Ethnic Group: White: Gypsy or Irish Traveller; measures: Value&quot;                       
##  [7] &quot;Sex: All persons; Age: Age 16 to 17; Ethnic Group: White: Other White; measures: Value&quot;                                    
##  [8] &quot;Sex: All persons; Age: Age 16 to 17; Ethnic Group: Mixed/multiple ethnic group: Total; measures: Value&quot;                    
##  [9] &quot;Sex: All persons; Age: Age 16 to 17; Ethnic Group: Mixed/multiple ethnic group: White and Black Caribbean; measures: Value&quot;
## [10] &quot;Sex: All persons; Age: Age 16 to 17; Ethnic Group: Mixed/multiple ethnic group: White and Black African; measures: Value&quot;  
## [11] &quot;Sex: All persons; Age: Age 16 to 17; Ethnic Group: Mixed/multiple ethnic group: White and Asian; measures: Value&quot;          
## [12] &quot;Sex: All persons; Age: Age 16 to 17; Ethnic Group: Mixed/multiple ethnic group: Other Mixed; measures: Value&quot;              
## [13] &quot;Sex: All persons; Age: Age 16 to 17; Ethnic Group: Asian/Asian British: Total; measures: Value&quot;                            
## [14] &quot;Sex: All persons; Age: Age 16 to 17; Ethnic Group: Asian/Asian British: Indian; measures: Value&quot;                           
## [15] &quot;Sex: All persons; Age: Age 16 to 17; Ethnic Group: Asian/Asian British: Pakistani; measures: Value&quot;                        
## [16] &quot;Sex: All persons; Age: Age 16 to 17; Ethnic Group: Asian/Asian British: Bangladeshi; measures: Value&quot;                      
## [17] &quot;Sex: All persons; Age: Age 16 to 17; Ethnic Group: Asian/Asian British: Chinese; measures: Value&quot;                          
## [18] &quot;Sex: All persons; Age: Age 16 to 17; Ethnic Group: Asian/Asian British: Other Asian; measures: Value&quot;                      
## [19] &quot;Sex: All persons; Age: Age 16 to 17; Ethnic Group: Black/African/Caribbean/Black British: Total; measures: Value&quot;          
## [20] &quot;Sex: All persons; Age: Age 16 to 17; Ethnic Group: Black/African/Caribbean/Black British: African; measures: Value&quot;        
## [21] &quot;Sex: All persons; Age: Age 16 to 17; Ethnic Group: Black/African/Caribbean/Black British: Caribbean; measures: Value&quot;      
## [22] &quot;Sex: All persons; Age: Age 16 to 17; Ethnic Group: Black/African/Caribbean/Black British: Other Black; measures: Value&quot;    
## [23] &quot;Sex: All persons; Age: Age 16 to 17; Ethnic Group: Other ethnic group: Total; measures: Value&quot;                             
## [24] &quot;Sex: All persons; Age: Age 16 to 17; Ethnic Group: Other ethnic group: Arab; measures: Value&quot;                              
## [25] &quot;Sex: All persons; Age: Age 16 to 17; Ethnic Group: Other ethnic group: Any other ethnic group; measures: Value&quot;            
## [26] &quot;Sex: All persons; Age: Age 18 to 19; Ethnic Group: All categories: Ethnic group; measures: Value&quot;                          
## [27] &quot;Sex: All persons; Age: Age 18 to 19; Ethnic Group: White: Total; measures: Value&quot;                                          
## [28] &quot;Sex: All persons; Age: Age 18 to 19; Ethnic Group: White: English/Welsh/Scottish/Northern Irish/British; measures: Value&quot;  
## [29] &quot;Sex: All persons; Age: Age 18 to 19; Ethnic Group: White: Irish; measures: Value&quot;                                          
## [30] &quot;Sex: All persons; Age: Age 18 to 19; Ethnic Group: White: Gypsy or Irish Traveller; measures: Value&quot;                       
##  [ reached getOption(&quot;max.print&quot;) -- omitted 355 entries ]</code></pre>
<p>The column names are all awfully long and it looks like the data have been split out into age groups. Further to this, the data contain within group total counts: <em>all categories</em>, <em>white total</em>, <em>mixed/multiple ethnic group total</em>, and so on.</p>
<div class="note">
<p><strong>Note</strong><br/>
You can also try using <code>View(df)</code> or use any other form of spreadsheet software (e.g. Microsoft Excel) to <strong>browse</strong> through the data set to get a better idea of what is happening and get a better idea of the structure of the data. You first will need to understand the structure of your data set before you can start reorganising your data set.</p>
</div>
<p>Although the data is messy and we will need to reorganise our data set, it does look there is some form of structure present that we can exploit: the various columns with population counts for each ethnic group are repeated for each of the different age groups. This means that we can go through the data frame in steps of equal size to select the data we want: starting from column 2 (column 1 only contains the reference to the administrative geography) we want to select all 24 columns of data for that particular age group. We can create a <code>for</code> loop that does exactly that:</p>
<div class="sourceCode" id="cb94"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb94-1"><a href="spatial-autocorrelation.html#cb94-1" aria-hidden="true" tabindex="-1"></a><span class="co"># loop through the columns of our data set</span></span>
<span id="cb94-2"><a href="spatial-autocorrelation.html#cb94-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (column <span class="cf">in</span> <span class="fu">seq</span>(<span class="dv">2</span>,<span class="fu">ncol</span>(df),<span class="dv">24</span>)) {</span>
<span id="cb94-3"><a href="spatial-autocorrelation.html#cb94-3" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb94-4"><a href="spatial-autocorrelation.html#cb94-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># index number of start column of age group</span></span>
<span id="cb94-5"><a href="spatial-autocorrelation.html#cb94-5" aria-hidden="true" tabindex="-1"></a>  start <span class="ot">&lt;-</span> column</span>
<span id="cb94-6"><a href="spatial-autocorrelation.html#cb94-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb94-7"><a href="spatial-autocorrelation.html#cb94-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># index number of end column of age group</span></span>
<span id="cb94-8"><a href="spatial-autocorrelation.html#cb94-8" aria-hidden="true" tabindex="-1"></a>  stop <span class="ot">&lt;-</span> column <span class="sc">+</span> <span class="dv">23</span> </span>
<span id="cb94-9"><a href="spatial-autocorrelation.html#cb94-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb94-10"><a href="spatial-autocorrelation.html#cb94-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># print results</span></span>
<span id="cb94-11"><a href="spatial-autocorrelation.html#cb94-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(<span class="fu">c</span>(start,stop))</span>
<span id="cb94-12"><a href="spatial-autocorrelation.html#cb94-12" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<pre><code>## [1]  2 25
## [1] 26 49
## [1] 50 73
## [1] 74 97
## [1]  98 121
## [1] 122 145
## [1] 146 169
## [1] 170 193
## [1] 194 217
## [1] 218 241
## [1] 242 265
## [1] 266 289
## [1] 290 313
## [1] 314 337
## [1] 338 361
## [1] 362 385</code></pre>
<p>For each age group in our data, the printed values should <strong>(!)</strong> correspond with the index number of the start column of the age group and the index number of the end column of the age group, respectively. Let’s do a sanity check.</p>
<div class="sourceCode" id="cb96"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb96-1"><a href="spatial-autocorrelation.html#cb96-1" aria-hidden="true" tabindex="-1"></a><span class="co"># sanity check: age group 16-17 (start column)</span></span>
<span id="cb96-2"><a href="spatial-autocorrelation.html#cb96-2" aria-hidden="true" tabindex="-1"></a>df[,<span class="dv">2</span>]</span></code></pre></div>
<pre><code>## # A tibble: 7,201 × 1
##    `Sex: All persons; Age: Age 16 to 17; Ethnic Group: All categories: Ethnic g…
##                                                                            &lt;dbl&gt;
##  1                                                                           215
##  2                                                                           175
##  3                                                                           140
##  4                                                                           160
##  5                                                                           132
##  6                                                                           270
##  7                                                                           124
##  8                                                                           150
##  9                                                                           178
## 10                                                                           162
## # … with 7,191 more rows</code></pre>
<div class="sourceCode" id="cb98"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb98-1"><a href="spatial-autocorrelation.html#cb98-1" aria-hidden="true" tabindex="-1"></a><span class="co"># sanity check: age group 16-17 (end column)</span></span>
<span id="cb98-2"><a href="spatial-autocorrelation.html#cb98-2" aria-hidden="true" tabindex="-1"></a>df[,<span class="dv">25</span>]</span></code></pre></div>
<pre><code>## # A tibble: 7,201 × 1
##    `Sex: All persons; Age: Age 16 to 17; Ethnic Group: Other ethnic group: Any …
##                                                                            &lt;dbl&gt;
##  1                                                                             0
##  2                                                                             0
##  3                                                                             0
##  4                                                                             0
##  5                                                                             0
##  6                                                                             0
##  7                                                                             0
##  8                                                                             0
##  9                                                                             0
## 10                                                                             0
## # … with 7,191 more rows</code></pre>
<div class="sourceCode" id="cb100"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb100-1"><a href="spatial-autocorrelation.html#cb100-1" aria-hidden="true" tabindex="-1"></a><span class="co"># sanity check: age group 18-19 (start column)</span></span>
<span id="cb100-2"><a href="spatial-autocorrelation.html#cb100-2" aria-hidden="true" tabindex="-1"></a>df[,<span class="dv">26</span>]</span></code></pre></div>
<pre><code>## # A tibble: 7,201 × 1
##    `Sex: All persons; Age: Age 18 to 19; Ethnic Group: All categories: Ethnic g…
##                                                                            &lt;dbl&gt;
##  1                                                                           157
##  2                                                                           129
##  3                                                                           102
##  4                                                                           162
##  5                                                                           121
##  6                                                                           217
##  7                                                                           126
##  8                                                                           231
##  9                                                                           175
## 10                                                                            95
## # … with 7,191 more rows</code></pre>
<div class="sourceCode" id="cb102"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb102-1"><a href="spatial-autocorrelation.html#cb102-1" aria-hidden="true" tabindex="-1"></a><span class="co"># sanity check: age group 18-19 (end column)</span></span>
<span id="cb102-2"><a href="spatial-autocorrelation.html#cb102-2" aria-hidden="true" tabindex="-1"></a>df[,<span class="dv">49</span>]</span></code></pre></div>
<pre><code>## # A tibble: 7,201 × 1
##    `Sex: All persons; Age: Age 18 to 19; Ethnic Group: Other ethnic group: Any …
##                                                                            &lt;dbl&gt;
##  1                                                                             1
##  2                                                                             0
##  3                                                                             0
##  4                                                                             0
##  5                                                                             0
##  6                                                                             0
##  7                                                                             0
##  8                                                                             1
##  9                                                                             0
## 10                                                                             0
## # … with 7,191 more rows</code></pre>
<p>All seems to be correct and we have successfully identified our columns. This is great, however, we still cannot work with our data as everything is spread out over different columns. Let’s fix this by manipulating the shape of our data by turning columns into rows.</p>
<div class="sourceCode" id="cb104"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb104-1"><a href="spatial-autocorrelation.html#cb104-1" aria-hidden="true" tabindex="-1"></a><span class="co"># create function</span></span>
<span id="cb104-2"><a href="spatial-autocorrelation.html#cb104-2" aria-hidden="true" tabindex="-1"></a>columns_to_rows <span class="ot">&lt;-</span> <span class="cf">function</span>(df, start, stop) {</span>
<span id="cb104-3"><a href="spatial-autocorrelation.html#cb104-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb104-4"><a href="spatial-autocorrelation.html#cb104-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># columns we are interested in</span></span>
<span id="cb104-5"><a href="spatial-autocorrelation.html#cb104-5" aria-hidden="true" tabindex="-1"></a>  col_sub <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">1</span>,start<span class="sc">:</span>stop)</span>
<span id="cb104-6"><a href="spatial-autocorrelation.html#cb104-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb104-7"><a href="spatial-autocorrelation.html#cb104-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># subset the dataframe </span></span>
<span id="cb104-8"><a href="spatial-autocorrelation.html#cb104-8" aria-hidden="true" tabindex="-1"></a>  df_sub <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="fu">select</span>(df,col_sub)</span>
<span id="cb104-9"><a href="spatial-autocorrelation.html#cb104-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb104-10"><a href="spatial-autocorrelation.html#cb104-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># pivot the columns in the dataframe, exclude the MSOA code column </span></span>
<span id="cb104-11"><a href="spatial-autocorrelation.html#cb104-11" aria-hidden="true" tabindex="-1"></a>  df_piv <span class="ot">&lt;-</span> <span class="fu">pivot_longer</span>(df_sub,<span class="sc">-</span>msoa11cd)</span>
<span id="cb104-12"><a href="spatial-autocorrelation.html#cb104-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb104-13"><a href="spatial-autocorrelation.html#cb104-13" aria-hidden="true" tabindex="-1"></a>  <span class="co"># rename columns</span></span>
<span id="cb104-14"><a href="spatial-autocorrelation.html#cb104-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">names</span>(df_piv) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&#39;msoa11cd&#39;</span>,<span class="st">&#39;age_group&#39;</span>,<span class="st">&#39;count&#39;</span>)</span>
<span id="cb104-15"><a href="spatial-autocorrelation.html#cb104-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(df_piv)</span>
<span id="cb104-16"><a href="spatial-autocorrelation.html#cb104-16" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb104-17"><a href="spatial-autocorrelation.html#cb104-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-18"><a href="spatial-autocorrelation.html#cb104-18" aria-hidden="true" tabindex="-1"></a><span class="co"># test</span></span>
<span id="cb104-19"><a href="spatial-autocorrelation.html#cb104-19" aria-hidden="true" tabindex="-1"></a><span class="fu">columns_to_rows</span>(df,<span class="dv">2</span>,<span class="dv">25</span>)</span></code></pre></div>
<pre><code>## # A tibble: 172,824 × 3
##    msoa11cd  age_group                                                     count
##    &lt;chr&gt;     &lt;chr&gt;                                                         &lt;dbl&gt;
##  1 E02002559 Sex: All persons; Age: Age 16 to 17; Ethnic Group: All categ…   215
##  2 E02002559 Sex: All persons; Age: Age 16 to 17; Ethnic Group: White: To…   206
##  3 E02002559 Sex: All persons; Age: Age 16 to 17; Ethnic Group: White: En…   204
##  4 E02002559 Sex: All persons; Age: Age 16 to 17; Ethnic Group: White: Ir…     0
##  5 E02002559 Sex: All persons; Age: Age 16 to 17; Ethnic Group: White: Gy…     2
##  6 E02002559 Sex: All persons; Age: Age 16 to 17; Ethnic Group: White: Ot…     0
##  7 E02002559 Sex: All persons; Age: Age 16 to 17; Ethnic Group: Mixed/mul…     4
##  8 E02002559 Sex: All persons; Age: Age 16 to 17; Ethnic Group: Mixed/mul…     1
##  9 E02002559 Sex: All persons; Age: Age 16 to 17; Ethnic Group: Mixed/mul…     2
## 10 E02002559 Sex: All persons; Age: Age 16 to 17; Ethnic Group: Mixed/mul…     1
## # … with 172,814 more rows</code></pre>
<p>This looks much better. Now let’s combine our loop with our newly created function to apply this to all of our data.</p>
<div class="sourceCode" id="cb106"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb106-1"><a href="spatial-autocorrelation.html#cb106-1" aria-hidden="true" tabindex="-1"></a><span class="co"># create an empty list to store our result from the loop</span></span>
<span id="cb106-2"><a href="spatial-autocorrelation.html#cb106-2" aria-hidden="true" tabindex="-1"></a>df_lst <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb106-3"><a href="spatial-autocorrelation.html#cb106-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-4"><a href="spatial-autocorrelation.html#cb106-4" aria-hidden="true" tabindex="-1"></a><span class="co"># loop through the columns of our data set</span></span>
<span id="cb106-5"><a href="spatial-autocorrelation.html#cb106-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (column <span class="cf">in</span> <span class="fu">seq</span>(<span class="dv">2</span>,<span class="fu">ncol</span>(df),<span class="dv">24</span>)) {</span>
<span id="cb106-6"><a href="spatial-autocorrelation.html#cb106-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb106-7"><a href="spatial-autocorrelation.html#cb106-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># index number of start column of age group</span></span>
<span id="cb106-8"><a href="spatial-autocorrelation.html#cb106-8" aria-hidden="true" tabindex="-1"></a>  start <span class="ot">&lt;-</span> column</span>
<span id="cb106-9"><a href="spatial-autocorrelation.html#cb106-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb106-10"><a href="spatial-autocorrelation.html#cb106-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># index number of end column of age group</span></span>
<span id="cb106-11"><a href="spatial-autocorrelation.html#cb106-11" aria-hidden="true" tabindex="-1"></a>  stop <span class="ot">&lt;-</span> column <span class="sc">+</span> <span class="dv">23</span> </span>
<span id="cb106-12"><a href="spatial-autocorrelation.html#cb106-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb106-13"><a href="spatial-autocorrelation.html#cb106-13" aria-hidden="true" tabindex="-1"></a>  <span class="co"># call our function and assign it to the list</span></span>
<span id="cb106-14"><a href="spatial-autocorrelation.html#cb106-14" aria-hidden="true" tabindex="-1"></a>  df_lst[[<span class="fu">length</span>(df_lst)<span class="sc">+</span><span class="dv">1</span>]] <span class="ot">&lt;-</span> <span class="fu">columns_to_rows</span>(df,<span class="at">start=</span>start,<span class="at">stop=</span>stop)</span>
<span id="cb106-15"><a href="spatial-autocorrelation.html#cb106-15" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb106-16"><a href="spatial-autocorrelation.html#cb106-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-17"><a href="spatial-autocorrelation.html#cb106-17" aria-hidden="true" tabindex="-1"></a><span class="co"># paste all elements from the list underneath one another</span></span>
<span id="cb106-18"><a href="spatial-autocorrelation.html#cb106-18" aria-hidden="true" tabindex="-1"></a><span class="co"># do.call executes the function &#39;rbind&#39; for all elements in our list</span></span>
<span id="cb106-19"><a href="spatial-autocorrelation.html#cb106-19" aria-hidden="true" tabindex="-1"></a>df_reformatted <span class="ot">&lt;-</span> <span class="fu">as_tibble</span>(<span class="fu">do.call</span>(rbind,df_lst))</span>
<span id="cb106-20"><a href="spatial-autocorrelation.html#cb106-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-21"><a href="spatial-autocorrelation.html#cb106-21" aria-hidden="true" tabindex="-1"></a><span class="co"># and the result</span></span>
<span id="cb106-22"><a href="spatial-autocorrelation.html#cb106-22" aria-hidden="true" tabindex="-1"></a>df_reformatted</span></code></pre></div>
<pre><code>## # A tibble: 2,765,184 × 3
##    msoa11cd  age_group                                                     count
##    &lt;chr&gt;     &lt;chr&gt;                                                         &lt;dbl&gt;
##  1 E02002559 Sex: All persons; Age: Age 16 to 17; Ethnic Group: All categ…   215
##  2 E02002559 Sex: All persons; Age: Age 16 to 17; Ethnic Group: White: To…   206
##  3 E02002559 Sex: All persons; Age: Age 16 to 17; Ethnic Group: White: En…   204
##  4 E02002559 Sex: All persons; Age: Age 16 to 17; Ethnic Group: White: Ir…     0
##  5 E02002559 Sex: All persons; Age: Age 16 to 17; Ethnic Group: White: Gy…     2
##  6 E02002559 Sex: All persons; Age: Age 16 to 17; Ethnic Group: White: Ot…     0
##  7 E02002559 Sex: All persons; Age: Age 16 to 17; Ethnic Group: Mixed/mul…     4
##  8 E02002559 Sex: All persons; Age: Age 16 to 17; Ethnic Group: Mixed/mul…     1
##  9 E02002559 Sex: All persons; Age: Age 16 to 17; Ethnic Group: Mixed/mul…     2
## 10 E02002559 Sex: All persons; Age: Age 16 to 17; Ethnic Group: Mixed/mul…     1
## # … with 2,765,174 more rows</code></pre>
<p>Now the data is in a much more manageable format, we can move on with preparing the data further. We will start by filtering out the columns (now rows!) that contain <em>all categories</em> and the <em>within group totals</em>. We will do this by cleverly filtering our data set on only a part of the text string that is contained in the <em>age_group</em> column of our dataframe using a <a href="https://en.wikipedia.org/wiki/Regular_expression">regular expression</a>. We further truncate the information that is contained in the <em>age_group</em> column to make all a little more readable.</p>
<div class="sourceCode" id="cb108"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb108-1"><a href="spatial-autocorrelation.html#cb108-1" aria-hidden="true" tabindex="-1"></a><span class="co"># filter rows</span></span>
<span id="cb108-2"><a href="spatial-autocorrelation.html#cb108-2" aria-hidden="true" tabindex="-1"></a><span class="co"># this can be a little slow because of the regular expression!</span></span>
<span id="cb108-3"><a href="spatial-autocorrelation.html#cb108-3" aria-hidden="true" tabindex="-1"></a>df_reformatted <span class="ot">&lt;-</span> <span class="fu">filter</span>(df_reformatted,<span class="sc">!</span><span class="fu">grepl</span>(<span class="st">&#39;*All categories*&#39;</span>,age_group))</span>
<span id="cb108-4"><a href="spatial-autocorrelation.html#cb108-4" aria-hidden="true" tabindex="-1"></a>df_reformatted <span class="ot">&lt;-</span> <span class="fu">filter</span>(df_reformatted,<span class="sc">!</span><span class="fu">grepl</span>(<span class="st">&#39;*Total*&#39;</span>,age_group))</span>
<span id="cb108-5"><a href="spatial-autocorrelation.html#cb108-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-6"><a href="spatial-autocorrelation.html#cb108-6" aria-hidden="true" tabindex="-1"></a><span class="co"># create variable that flags the 85 and over category</span></span>
<span id="cb108-7"><a href="spatial-autocorrelation.html#cb108-7" aria-hidden="true" tabindex="-1"></a><span class="co"># this can be a little slow because of the regular expression!</span></span>
<span id="cb108-8"><a href="spatial-autocorrelation.html#cb108-8" aria-hidden="true" tabindex="-1"></a>df_reformatted<span class="sc">$</span>g <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="fu">grepl</span>(<span class="st">&#39;85&#39;</span>,<span class="fu">as.character</span>(df_reformatted<span class="sc">$</span>age_group)),<span class="dv">1</span>,<span class="dv">0</span>)</span>
<span id="cb108-9"><a href="spatial-autocorrelation.html#cb108-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-10"><a href="spatial-autocorrelation.html#cb108-10" aria-hidden="true" tabindex="-1"></a><span class="co"># select information from character 41 (85 and over category) or from character 38</span></span>
<span id="cb108-11"><a href="spatial-autocorrelation.html#cb108-11" aria-hidden="true" tabindex="-1"></a>df_reformatted <span class="ot">&lt;-</span> <span class="fu">mutate</span>(df_reformatted,<span class="at">group =</span> <span class="fu">ifelse</span>(g<span class="sc">==</span><span class="dv">0</span>,<span class="fu">substr</span>(<span class="fu">as.character</span>(age_group),<span class="dv">38</span>,<span class="dv">500</span>),</span>
<span id="cb108-12"><a href="spatial-autocorrelation.html#cb108-12" aria-hidden="true" tabindex="-1"></a>                                                            <span class="fu">substr</span>(<span class="fu">as.character</span>(age_group),<span class="dv">41</span>,<span class="dv">500</span>))) </span>
<span id="cb108-13"><a href="spatial-autocorrelation.html#cb108-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-14"><a href="spatial-autocorrelation.html#cb108-14" aria-hidden="true" tabindex="-1"></a><span class="co"># remove unnecessary columns</span></span>
<span id="cb108-15"><a href="spatial-autocorrelation.html#cb108-15" aria-hidden="true" tabindex="-1"></a>df_reformatted <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="fu">select</span>(df_reformatted, <span class="sc">-</span>age_group, <span class="sc">-</span>g)</span></code></pre></div>
<p>We are now really getting somewhere, although in order for our data to be tidy each variable must have its own column. We also want, within each ethnic group, to aggregate the individual values within each age group.</p>
<div class="sourceCode" id="cb109"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb109-1"><a href="spatial-autocorrelation.html#cb109-1" aria-hidden="true" tabindex="-1"></a><span class="co"># pivot table and aggregate values</span></span>
<span id="cb109-2"><a href="spatial-autocorrelation.html#cb109-2" aria-hidden="true" tabindex="-1"></a>df_clean <span class="ot">&lt;-</span> <span class="fu">pivot_wider</span>(df_reformatted,<span class="at">names_from=</span>group,<span class="at">values_from=</span>count,<span class="at">values_fn=</span>sum)</span>
<span id="cb109-3"><a href="spatial-autocorrelation.html#cb109-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb109-4"><a href="spatial-autocorrelation.html#cb109-4" aria-hidden="true" tabindex="-1"></a><span class="co"># rename columns</span></span>
<span id="cb109-5"><a href="spatial-autocorrelation.html#cb109-5" aria-hidden="true" tabindex="-1"></a><span class="co"># names are assigned based on index values, so make sure that the current column names match the</span></span>
<span id="cb109-6"><a href="spatial-autocorrelation.html#cb109-6" aria-hidden="true" tabindex="-1"></a><span class="co"># order of the new colum names otherwise our whole analysis will be wrong!</span></span>
<span id="cb109-7"><a href="spatial-autocorrelation.html#cb109-7" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(df_clean) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&#39;msoa11cd&#39;</span>,<span class="st">&#39;white_british&#39;</span>,<span class="st">&#39;white_irish&#39;</span>,<span class="st">&#39;white_traveller&#39;</span>,<span class="st">&#39;white_other&#39;</span>,<span class="st">&#39;mixed_white_black_caribbean&#39;</span>,</span>
<span id="cb109-8"><a href="spatial-autocorrelation.html#cb109-8" aria-hidden="true" tabindex="-1"></a>                     <span class="st">&#39;mixed_white_black_african&#39;</span>,<span class="st">&#39;mixed_white_asian&#39;</span>,<span class="st">&#39;mixed_other&#39;</span>,<span class="st">&#39;asian_indian&#39;</span>,<span class="st">&#39;asian_pakistani&#39;</span>,</span>
<span id="cb109-9"><a href="spatial-autocorrelation.html#cb109-9" aria-hidden="true" tabindex="-1"></a>                     <span class="st">&#39;asian_bangladeshi&#39;</span>,<span class="st">&#39;asian_chinese&#39;</span>,<span class="st">&#39;asian_other&#39;</span>,<span class="st">&#39;black_african&#39;</span>,<span class="st">&#39;black_caribbean&#39;</span>,<span class="st">&#39;black_other&#39;</span>,</span>
<span id="cb109-10"><a href="spatial-autocorrelation.html#cb109-10" aria-hidden="true" tabindex="-1"></a>                     <span class="st">&#39;other_arab&#39;</span>,<span class="st">&#39;other_other&#39;</span>)</span>
<span id="cb109-11"><a href="spatial-autocorrelation.html#cb109-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb109-12"><a href="spatial-autocorrelation.html#cb109-12" aria-hidden="true" tabindex="-1"></a><span class="co"># tidy data</span></span>
<span id="cb109-13"><a href="spatial-autocorrelation.html#cb109-13" aria-hidden="true" tabindex="-1"></a>df_clean</span></code></pre></div>
<pre><code>## # A tibble: 7,201 × 19
##    msoa11cd  white_british white_irish white_traveller white_other
##    &lt;chr&gt;             &lt;dbl&gt;       &lt;dbl&gt;           &lt;dbl&gt;       &lt;dbl&gt;
##  1 E02002559          6775          17              27          51
##  2 E02002560          4688          11               8          31
##  3 E02002561          4609          20               3          55
##  4 E02002562          4653           4               6         131
##  5 E02002563          4369          13               2          38
##  6 E02002564          7320          11               3          73
##  7 E02002565          4274          16               2          96
##  8 E02002566          4713          33              24         308
##  9 E02002567          5344          17              42         111
## 10 E02002568          4583          29               6         100
## # … with 7,191 more rows, and 14 more variables:
## #   mixed_white_black_caribbean &lt;dbl&gt;, mixed_white_black_african &lt;dbl&gt;,
## #   mixed_white_asian &lt;dbl&gt;, mixed_other &lt;dbl&gt;, asian_indian &lt;dbl&gt;,
## #   asian_pakistani &lt;dbl&gt;, asian_bangladeshi &lt;dbl&gt;, asian_chinese &lt;dbl&gt;,
## #   asian_other &lt;dbl&gt;, black_african &lt;dbl&gt;, black_caribbean &lt;dbl&gt;,
## #   black_other &lt;dbl&gt;, other_arab &lt;dbl&gt;, other_other &lt;dbl&gt;</code></pre>
<p>Finally. We now have a <strong>tidy data set</strong> that we can work with!</p>
</div>
</div>
<div id="assignment_w04" class="section level2" number="2.14">
<h2><span class="header-section-number">2.14</span> Assignment</h2>
<div id="part-a" class="section level4 unnumbered">
<h4>Part A</h4>
<p>Since we went through all the trouble of cleaning and creating this file, now try and use the cleaned data set to create a table that, for each MSOA, contains the proportions of the population belonging to each of the ethnic groups in the UK 2011 Census of Population. It could look something like this:</p>
<table>
<thead>
<tr class="header">
<th align="left">msoa11cd</th>
<th align="center">white_british</th>
<th align="center">white_irish</th>
<th align="center">etc.</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">E02002562</td>
<td align="center">0.74</td>
<td align="center">0.03</td>
<td align="center">…</td>
</tr>
<tr class="even">
<td align="left">E02002560</td>
<td align="center">0.32</td>
<td align="center">0.32</td>
<td align="center">…</td>
</tr>
</tbody>
</table>
</div>
<div id="tips" class="section level4 unnumbered">
<h4>Tips</h4>
<ol style="list-style-type: decimal">
<li>First think what you what steps you would need to take in order to get the group proportions. Write them down on a piece of paper if you like. Once you have identified the steps, then start coding.</li>
<li>Conduct sanity checks. Every time you have written a line of code, check the results to see if the code did indeed give the result that you expected to get.</li>
<li>Google is your friend. Do not be afraid to search for specific solutions and suggestions, chances are that there have been other people who have faces similar problems and posted their questions on <a href="https://stackoverflow.com/">stackoverflow</a>.</li>
</ol>
</div>
<div id="part-b" class="section level4 unnumbered">
<h4>Part B</h4>
<p>Further to calculating the proportions of the population belonging to each of the ethnic groups in the UK 2011 Census of Population, we also want to make a choropleth map at district level of the UK population that is older than 60 (as a proportion of the total population within each district). For this analysis we have available one data set with the administrative boundaries of the UK 2020 Local Authority Districts administrative geography and we have a <code>csv</code> file that holds population estimates for the UK in 2019. Use everything you have learned over the past weeks to produces this map. Some tips:</p>
</div>
<div id="tips-1" class="section level4 unnumbered">
<h4>Tips</h4>
<ol style="list-style-type: decimal">
<li>Inspect both the shapefile and the <code>csv</code> file to get an idea of how your data look like. Use any tool you like to do this inspection (ArcGIS, R, QGIS, Microsoft Excel, etc.).</li>
<li>The <code>csv</code> file does contain a mix of administrative geographies, and you will need to do some data cleaning by filtering out <em>Country</em>, <em>County</em>, <em>Metropolitan County</em>, and <em>Region</em> before you link the data to the shapefile.</li>
<li>You are in charge of deciding what software you want to use to visualise the data (ArcGIS, R, QGIS, etc.).</li>
<li>You now have to make your own decisions on how to go about this problem. Although this practical has so far covered some of the functions and strategies you might need, the data cleaning and data preparation process is not the same.</li>
</ol>
</div>
<div id="file-download-3" class="section level4 unnumbered">
<h4>File download</h4>
<table>
<thead>
<tr class="header">
<th align="left">File</th>
<th align="left">Type</th>
<th align="left">Link</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">Local Authorithy District boundaries 2020</td>
<td align="left"><code>shp</code></td>
<td align="left"><a href="https://github.com/jtvandijk/GEOG0114/tree/master/data/zip/LADs_uk_2020.zip">Download</a></td>
</tr>
<tr class="even">
<td align="left">Mid-Year Population Estimates 2019</td>
<td align="left"><code>csv</code></td>
<td align="left"><a href="https://github.com/jtvandijk/GEOG0114/tree/master/data/zip/mye_pop_2019.zip">Download</a></td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="attributions_w04" class="section level2" number="2.15">
<h2><span class="header-section-number">2.15</span> Attributions</h2>
<p>This week’s content and practical uses content and inspiration from:</p>
<ul>
<li>Long, Alfie. 2020. Spatial autocorrelation. <a href="https://github.com/jtvandijk/GEOG0114_20202021/blob/master/04-week04.Rmd" class="uri">https://github.com/jtvandijk/GEOG0114_20202021/blob/master/04-week04.Rmd</a></li>
<li>Gimond, Manuel. 2021. Spatial autocorrelation in R. <a href="https://mgimond.github.io/Spatial/spatial-autocorrelation-in-r.html" class="uri">https://mgimond.github.io/Spatial/spatial-autocorrelation-in-r.html</a></li>
</ul>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="spatial-operations.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="point-pattern-analysis.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": true,
"facebook": false,
"twitter": false,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": false
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/jtvandijk/GEOG0114_20212022/edit/master/02-spatial-autocorrelation.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["https://github.com/jtvandijk/GEOG0114_20212022/raw/master/02-spatial-autocorrelation.Rmd"],
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "section"
}
});
});
</script>

</body>

</html>
